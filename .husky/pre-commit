#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# å³æ ¼ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆDefensive Programmingï¼‰
set -euo pipefail

# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°ï¼ˆDRYåŸå‰‡ï¼‰
readonly ERROR_TYPE_CHECK="âŒ TypeScript type check failed. Please fix type errors before committing."
readonly ERROR_LINT_CHECK="âŒ ESLint check failed. Please fix linting errors before committing."
readonly ERROR_BUILD_CHECK="âŒ Build failed. Please ensure the code builds successfully."
readonly ERROR_TEST_CHECK="âŒ One or more tests failed. Please fix failing tests before committing."
readonly ERROR_NAMING_CHECK="âŒ å‘½åè¦å‰‡é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ docs/NAMING_CONVENTIONS.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚"
readonly ERROR_ANY_TYPE_CHECK="âŒ anyå‹ã®ä½¿ç”¨ãŒå¢—åŠ ã—ã¦ã„ã¾ã™ã€‚'node scripts/convert-any-to-unknown.js --dry-run' ã§anyå‹ã‚’unknownå‹ã«å¤‰æ›ã§ãã¾ã™"
readonly ERROR_CACHE_FILE_CHECK="âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¤ã‚³ãƒŸãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆIssue #118å¯¾å¿œï¼‰ã€‚.gitignoreã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆå˜ä¸€è²¬ä»»åŸå‰‡ï¼‰
handle_check_failure() {
    local error_message="$1"
    local step_name="$2"
    
    echo "$error_message"
    echo "ğŸ’¡ Pre-commit check '$step_name' failed. Run the check manually to see detailed errors."
    exit 1
}

# ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œé–¢æ•°ï¼ˆé–¢æ•°æŠ½å‡ºãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
run_type_check() {
    echo "ğŸ“ Running TypeScript type check..."
    if ! npx tsc --noEmit; then
        handle_check_failure "$ERROR_TYPE_CHECK" "TypeScript type check"
    fi
}

run_lint_check() {
    echo "ğŸ”§ Running ESLint..."
    if ! npx lint-staged; then
        handle_check_failure "$ERROR_LINT_CHECK" "ESLint check"
    fi
}

run_build_check() {
    echo "ğŸ—ï¸ Running build..."
    if ! npm run build > /dev/null 2>&1; then
        handle_check_failure "$ERROR_BUILD_CHECK" "Build check"
    fi
}

run_test_check() {
    echo "ğŸ§ª Running tests for changed files..."
    local test_failed=0
    
    # ãƒ—ãƒ­ã‚»ã‚¹ç½®æ›ã‚’ä½¿ç”¨ã—ã¦çµ‚äº†ã‚³ãƒ¼ãƒ‰ä¼æ’­å•é¡Œã‚’è§£æ±ºï¼ˆIssue #98 ä¿®æ­£ï¼‰
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            echo "  Testing: $file"
            if ! npm test -- "$file" --no-coverage 2>&1 | grep -E "(PASS|FAIL)" > /dev/null; then
                echo "âŒ Test failed for $file"
                test_failed=1
                break
            else
                echo "âœ… Test passed for $file"
            fi
        fi
    done < <(git diff --cached --name-only | grep -E "\.test\.ts$")
    
    if [ $test_failed -ne 0 ]; then
        handle_check_failure "$ERROR_TEST_CHECK" "Test execution"
    fi
}

run_naming_conventions_check() {
    echo "ğŸ“ Checking naming conventions..."
    local staged_ts_files
    staged_ts_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)
    
    if [ -n "$staged_ts_files" ]; then
        local naming_errors=0
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åãƒã‚§ãƒƒã‚¯
        local version_files
        version_files=$(echo "$staged_ts_files" | grep -E 'v[0-9]+\.[0-9]+' || true)
        if [ -n "$version_files" ]; then
            echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
            echo "$version_files" | sed 's/^/  - /'
            naming_errors=$((naming_errors + 1))
        fi
        
        # Implã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯
        local impl_files
        impl_files=$(echo "$staged_ts_files" | grep -E 'Impl\.ts$' || true)
        if [ -n "$impl_files" ]; then
            echo "âŒ *Impl.tsã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
            echo "$impl_files" | sed 's/^/  - /'
            naming_errors=$((naming_errors + 1))
        fi
        
        # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å‘½åãƒã‚§ãƒƒã‚¯
        local plugin_files
        plugin_files=$(echo "$staged_ts_files" | grep -E 'src/plugins/.*\.ts$' || true)
        if [ -n "$plugin_files" ]; then
            for file in $plugin_files; do
                local basename
                basename=$(basename "$file" .ts)
                if echo "$file" | grep -q "/plugins/" && ! echo "$basename" | grep -qE 'Plugin$|BasePlugin$'; then
                    echo "âŒ ä¸é©åˆ‡ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å‘½å: $file"
                    echo "ğŸ’¡ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯*Plugin.tså½¢å¼ã«ã—ã¦ãã ã•ã„"
                    naming_errors=$((naming_errors + 1))
                fi
            done
        fi
        
        if [ $naming_errors -ne 0 ]; then
            handle_check_failure "$ERROR_NAMING_CHECK" "Naming conventions"
        else
            echo "  âœ… å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯é€šé"
        fi
    fi
}

run_any_type_check() {
    echo "ğŸ” Checking any type usage..."
    local new_any_count
    new_any_count=$(grep -r ": any" src --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l | tr -d ' ')
    echo "  Current any type usage: $new_any_count"
    
    if [ "$new_any_count" -gt "560" ]; then
        echo "ç¾åœ¨: $new_any_countã€ä¸Šé™: 560"
        echo "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: 'node scripts/convert-any-to-unknown.js --dry-run' ã§anyå‹ã‚’unknownå‹ã«å¤‰æ›ã§ãã¾ã™"
        handle_check_failure "$ERROR_ANY_TYPE_CHECK" "Any type usage"
    fi
}

run_circular_dependency_check() {
    if [ -f "scripts/check-circular-deps.js" ]; then
        echo "ğŸ” Checking circular dependencies..."
        if ! node scripts/check-circular-deps.js > /dev/null 2>&1; then
            echo "âš ï¸  å¾ªç’°å‚ç…§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ 'node scripts/check-circular-deps.js' ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            # è­¦å‘Šã®ã¿ã§ã€ã‚³ãƒŸãƒƒãƒˆã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
        fi
    fi
}

run_cache_file_check() {
    echo "ğŸ—„ï¸ Checking for cache files (Issue #118)..."
    local cache_file_errors=0
    local staged_files
    staged_files=$(git diff --cached --name-only --diff-filter=ACM || true)
    
    if [ -n "$staged_files" ]; then
        # Issue #118ã§ç‰¹å®šã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³
        local cache_patterns=(
            "\.map$"                    # ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
            "\.d\.ts\.map$"            # TypeScript declaration map
            "\.js\.map$"               # JavaScript map
            "\.css\.map$"              # CSS map
            "\.jest-cache/"            # Jest cache
            "\.ts-jest/"               # ts-jest cache
            "\.tsbuildinfo$"           # TypeScript build info
            "\.cache/"                 # ä¸€èˆ¬ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            "\.turbo/"                 # Turbo cache
            "\.nx/cache/"              # Nx cache
            "\.vite/cache/"            # Vite cache
            "\.parcel-cache/"          # Parcel cache
            "node_modules\.cache"      # npm cache
            "jest-transform-cache-"    # Jest transform cache (Issue #118ç‰¹å®šãƒ‘ã‚¿ãƒ¼ãƒ³)
        )
        
        for pattern in "${cache_patterns[@]}"; do
            local matching_files
            matching_files=$(echo "$staged_files" | grep -E "$pattern" || true)
            
            if [ -n "$matching_files" ]; then
                echo "âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ '$pattern' ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:"
                echo "$matching_files" | sed 's/^/    /'
                cache_file_errors=$((cache_file_errors + 1))
            fi
        done
        
        # PIIéœ²å‡ºãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹åˆ¥ãƒã‚§ãƒƒã‚¯
        local pii_risk_files
        pii_risk_files=$(echo "$staged_files" | grep -E "\.(map|log)$" || true)
        if [ -n "$pii_risk_files" ]; then
            echo "âš ï¸  PIIéœ²å‡ºãƒªã‚¹ã‚¯: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:"
            echo "$pii_risk_files" | sed 's/^/    /'
            cache_file_errors=$((cache_file_errors + 1))
        fi
        
        if [ $cache_file_errors -ne 0 ]; then
            echo ""
            echo "ğŸ’¡ ä¿®å¾©æ–¹æ³•:"
            echo "   1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Gitã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å‰Šé™¤:"
            echo "      git rm --cached <filename>"
            echo "   2. .gitignoreã«é©åˆ‡ãªé™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
            echo "   3. TypeScriptè¨­å®šã§sourceMapã‚’ç„¡åŠ¹åŒ– (tsconfig.json)"
            echo "   4. è©³ç´°ã¯ Issue #118 ã‚’å‚ç…§"
            echo ""
            handle_check_failure "$ERROR_CACHE_FILE_CHECK" "Cache file check"
        else
            echo "  âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯é€šé"
        fi
    fi
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œéƒ¨åˆ†ï¼ˆã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’é †æ¬¡å®Ÿè¡Œï¼‰
main() {
    echo "ğŸ” Pre-commit checks starting..."
    
    # å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆå¤±æ•—æ™‚ã¯å³åº§ã«exitï¼‰
    run_cache_file_check           # Issue #118å¯¾å¿œ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«èª¤ã‚³ãƒŸãƒƒãƒˆé˜²æ­¢ï¼ˆæœ€å„ªå…ˆï¼‰
    run_type_check
    run_lint_check
    run_build_check
    run_test_check
    run_naming_conventions_check
    run_any_type_check
    
    # è­¦å‘Šã®ã¿ã®ãƒã‚§ãƒƒã‚¯
    run_circular_dependency_check
    
    echo "âœ… All pre-commit checks passed!"
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆIssue #98ä¿®æ­£ã«ã‚ˆã‚Šã€çµ‚äº†ã‚³ãƒ¼ãƒ‰ä¼æ’­ãŒç¢ºå®Ÿã«å‹•ä½œï¼‰
main "$@"