#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Pre-commit checks starting..."

# TypeScriptÂûã„ÉÅ„Çß„ÉÉ„ÇØ
echo "üìù Running TypeScript type check..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript type check failed. Please fix type errors before committing."
  exit 1
fi

# ESLint„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÔºâ
echo "üîß Running ESLint..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "‚ùå ESLint check failed. Please fix linting errors before committing."
  exit 1
fi

# „Éì„É´„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
echo "üèóÔ∏è Running build..."
npm run build > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "‚ùå Build failed. Please ensure the code builds successfully."
  exit 1
fi

# Â§âÊõ¥„Åï„Çå„Åü„ÉÜ„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅÆÂÆüË°å
echo "üß™ Running tests for changed files..."
git diff --cached --name-only | grep -E "\.test\.ts$" | while read file; do
  if [ -f "$file" ]; then
    npm test -- "$file" --no-coverage 2>&1 | grep -E "(PASS|FAIL)"
    if [ $? -ne 0 ]; then
      echo "‚ùå Test failed for $file"
      exit 1
    fi
  fi
done

echo "‚úÖ All pre-commit checks passed!"