#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# å³æ ¼ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆDefensive Programmingï¼‰
set -euo pipefail

# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°ï¼ˆDRYåŸå‰‡ï¼‰
readonly ERROR_TYPE_CHECK="âŒ TypeScript type check failed. Please fix type errors before committing."
readonly ERROR_LINT_CHECK="âŒ ESLint check failed. Please fix linting errors before committing."
readonly ERROR_BUILD_CHECK="âŒ Build failed. Please ensure the code builds successfully."
readonly ERROR_TEST_CHECK="âŒ One or more tests failed. Please fix failing tests before committing."
readonly ERROR_NAMING_CHECK="âŒ å‘½åè¦å‰‡é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ docs/NAMING_CONVENTIONS.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚"
readonly ERROR_ANY_TYPE_CHECK="âŒ anyå‹ã®ä½¿ç”¨ãŒå¢—åŠ ã—ã¦ã„ã¾ã™ã€‚'node scripts/convert-any-to-unknown.js --dry-run' ã§anyå‹ã‚’unknownå‹ã«å¤‰æ›ã§ãã¾ã™"

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆå˜ä¸€è²¬ä»»åŸå‰‡ï¼‰
handle_check_failure() {
    local error_message="$1"
    local step_name="$2"
    
    echo "$error_message"
    echo "ğŸ’¡ Pre-commit check '$step_name' failed. Run the check manually to see detailed errors."
    exit 1
}

# ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œé–¢æ•°ï¼ˆé–¢æ•°æŠ½å‡ºãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
run_type_check() {
    echo "ğŸ“ Running TypeScript type check..."
    if ! npx tsc --noEmit; then
        handle_check_failure "$ERROR_TYPE_CHECK" "TypeScript type check"
    fi
}

run_lint_check() {
    echo "ğŸ”§ Running ESLint..."
    if ! npx lint-staged; then
        handle_check_failure "$ERROR_LINT_CHECK" "ESLint check"
    fi
}

run_build_check() {
    echo "ğŸ—ï¸ Running build..."
    if ! npm run build > /dev/null 2>&1; then
        handle_check_failure "$ERROR_BUILD_CHECK" "Build check"
    fi
}

run_test_check() {
    echo "ğŸ§ª Running tests for changed files..."
    local test_failed=0
    
    # ãƒ—ãƒ­ã‚»ã‚¹ç½®æ›ã‚’ä½¿ç”¨ã—ã¦çµ‚äº†ã‚³ãƒ¼ãƒ‰ä¼æ’­å•é¡Œã‚’è§£æ±ºï¼ˆIssue #98 ä¿®æ­£ï¼‰
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            echo "  Testing: $file"
            if ! npm test -- "$file" --no-coverage 2>&1 | grep -E "(PASS|FAIL)" > /dev/null; then
                echo "âŒ Test failed for $file"
                test_failed=1
                break
            else
                echo "âœ… Test passed for $file"
            fi
        fi
    done < <(git diff --cached --name-only | grep -E "\.test\.ts$")
    
    if [ $test_failed -ne 0 ]; then
        handle_check_failure "$ERROR_TEST_CHECK" "Test execution"
    fi
}

run_naming_conventions_check() {
    echo "ğŸ“ Checking naming conventions..."
    local staged_ts_files
    staged_ts_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)
    
    if [ -n "$staged_ts_files" ]; then
        local naming_errors=0
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åãƒã‚§ãƒƒã‚¯
        local version_files
        version_files=$(echo "$staged_ts_files" | grep -E 'v[0-9]+\.[0-9]+' || true)
        if [ -n "$version_files" ]; then
            echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
            echo "$version_files" | sed 's/^/  - /'
            naming_errors=$((naming_errors + 1))
        fi
        
        # Implã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯
        local impl_files
        impl_files=$(echo "$staged_ts_files" | grep -E 'Impl\.ts$' || true)
        if [ -n "$impl_files" ]; then
            echo "âŒ *Impl.tsã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
            echo "$impl_files" | sed 's/^/  - /'
            naming_errors=$((naming_errors + 1))
        fi
        
        # ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å‘½åãƒã‚§ãƒƒã‚¯
        local plugin_files
        plugin_files=$(echo "$staged_ts_files" | grep -E 'src/plugins/.*\.ts$' || true)
        if [ -n "$plugin_files" ]; then
            for file in $plugin_files; do
                local basename
                basename=$(basename "$file" .ts)
                if [[ "$file" == *"/plugins/"* ]] && ! echo "$basename" | grep -qE 'Plugin$|BasePlugin$'; then
                    echo "âŒ ä¸é©åˆ‡ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å‘½å: $file"
                    echo "ğŸ’¡ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯*Plugin.tså½¢å¼ã«ã—ã¦ãã ã•ã„"
                    naming_errors=$((naming_errors + 1))
                fi
            done
        fi
        
        if [ $naming_errors -ne 0 ]; then
            handle_check_failure "$ERROR_NAMING_CHECK" "Naming conventions"
        else
            echo "  âœ… å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯é€šé"
        fi
    fi
}

run_any_type_check() {
    echo "ğŸ” Checking any type usage..."
    local new_any_count
    new_any_count=$(grep -r ": any" src --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l | tr -d ' ')
    echo "  Current any type usage: $new_any_count"
    
    if [ "$new_any_count" -gt "560" ]; then
        echo "ç¾åœ¨: $new_any_countã€ä¸Šé™: 560"
        echo "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: 'node scripts/convert-any-to-unknown.js --dry-run' ã§anyå‹ã‚’unknownå‹ã«å¤‰æ›ã§ãã¾ã™"
        handle_check_failure "$ERROR_ANY_TYPE_CHECK" "Any type usage"
    fi
}

run_circular_dependency_check() {
    if [ -f "scripts/check-circular-deps.js" ]; then
        echo "ğŸ” Checking circular dependencies..."
        if ! node scripts/check-circular-deps.js > /dev/null 2>&1; then
            echo "âš ï¸  å¾ªç’°å‚ç…§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ 'node scripts/check-circular-deps.js' ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            # è­¦å‘Šã®ã¿ã§ã€ã‚³ãƒŸãƒƒãƒˆã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
        fi
    fi
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œéƒ¨åˆ†ï¼ˆã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’é †æ¬¡å®Ÿè¡Œï¼‰
main() {
    echo "ğŸ” Pre-commit checks starting..."
    
    # å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆå¤±æ•—æ™‚ã¯å³åº§ã«exitï¼‰
    run_type_check
    run_lint_check
    run_build_check
    run_test_check
    run_naming_conventions_check
    run_any_type_check
    
    # è­¦å‘Šã®ã¿ã®ãƒã‚§ãƒƒã‚¯
    run_circular_dependency_check
    
    echo "âœ… All pre-commit checks passed!"
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆIssue #98ä¿®æ­£ã«ã‚ˆã‚Šã€çµ‚äº†ã‚³ãƒ¼ãƒ‰ä¼æ’­ãŒç¢ºå®Ÿã«å‹•ä½œï¼‰
main "$@"