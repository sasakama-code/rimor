name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ã‚¸ãƒ§ãƒ–1: ãƒ“ãƒ«ãƒ‰ã¨åŸºæœ¬æ¤œè¨¼
  build-and-verify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Type check
      run: npx tsc --noEmit

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.node-version }}
        path: dist/
        retention-days: 1

  # ã‚¸ãƒ§ãƒ–2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆTaintTyperå«ã‚€ï¼‰
  security-audit:
    runs-on: ubuntu-latest
    needs: build-and-verify
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-20.x
        path: dist/

    - name: Run comprehensive security check
      run: npm run security-check

    - name: Upload security audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-results
        path: |
          .rimor/reports/security/audit-results.json
          .rimor/reports/security/security-analysis-report.json
        if-no-files-found: ignore

  # ã‚¸ãƒ§ãƒ–3: å“è³ªç›£æŸ»ï¼ˆdogfoodingï¼‰
  quality-audit:
    runs-on: ubuntu-latest
    needs: build-and-verify
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-20.x
        path: dist/

    - name: Run quality audit (dogfooding)
      run: |
        # æ–°ã—ã„å“è³ªç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        if [ -f scripts/quality-audit.js ]; then
          node scripts/quality-audit.js
        else
          # æš«å®šçš„ã«æ—¢å­˜ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          mkdir -p .rimor/reports/quality
          npm run analyze:src:json > .rimor/reports/quality/quality-audit-results.json
          ANALYSIS_EXIT_CODE=$?
          
          if [ "$ANALYSIS_EXIT_CODE" -gt 1 ]; then
            echo "::error::Quality audit failed with exit code $ANALYSIS_EXIT_CODE"
            exit 1
          fi
          
          # çµæœã®åˆ†æ
          if [ -f .rimor/reports/quality/quality-audit-results.json ]; then
            if ! jq empty .rimor/reports/quality/quality-audit-results.json 2>/dev/null; then
              echo "::error::Invalid JSON in quality-audit-results.json"
              exit 1
            fi
            
            TOTAL_ISSUES=$(jq '.issues | length' .rimor/reports/quality/quality-audit-results.json)
            echo "Total quality issues found: $TOTAL_ISSUES"
            
            # å“è³ªã‚¹ã‚³ã‚¢ã®è¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if jq -e '.qualityScore' .rimor/reports/quality/quality-audit-results.json >/dev/null 2>&1; then
              QUALITY_SCORE=$(jq '.qualityScore' .rimor/reports/quality/quality-audit-results.json)
              echo "Overall quality score: $QUALITY_SCORE"
            fi
          fi
        fi

    - name: Upload quality audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-audit-results
        path: |
          .rimor/reports/quality/quality-audit-results.json
          .rimor/reports/quality/dogfooding-report.json
        if-no-files-found: ignore

  # ã‚¸ãƒ§ãƒ–4: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    needs: [security-audit, quality-audit]
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ matrix.node-version }}
        path: dist/

    - name: Run tests
      env:
        NODE_OPTIONS: '--max-old-space-size=2048'
        DISABLE_SECURITY_VALIDATION_LOGS: 'true'
      run: npm test

    - name: Upload AI Error Report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ai-error-report-${{ matrix.node-version }}
        path: |
          .rimor/reports/test-errors-ai.md
          .rimor/reports/test-errors-ai.json

    - name: Post AI Error Report Summary to PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true
      env:
        NODE_VERSION: ${{ matrix.node-version }}
      with:
        script: |
          const fs = require('fs');
          const summaryPath = '.rimor/reports/test-errors-ai-summary.md';
          
          if (fs.existsSync(summaryPath)) {
            const summary = fs.readFileSync(summaryPath, 'utf8');
            
            // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactsMessage = `\n\nğŸ“ **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: [ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ](${runUrl})ã‹ã‚‰ \`ai-error-report-${process.env.NODE_VERSION}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            
            const body = `## ğŸ¤– AI Error Report (Node.js ${process.env.NODE_VERSION})\n\n${summary}${artifactsMessage}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
          }

  # npmå…¬é–‹ã®æº–å‚™ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  publish-dry-run:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-20.x
        path: dist/

    - name: Test npm package
      run: npm pack --dry-run