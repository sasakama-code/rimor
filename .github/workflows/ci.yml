name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit

    - name: Run lint check
      run: npm run lint
      continue-on-error: true  # MVPæœŸé–“ä¸­ã¯lintã‚¨ãƒ©ãƒ¼ã§CIã‚’æ­¢ã‚ãªã„

    - name: Clean generated files before build
      run: |
        echo "ğŸ§¹ Cleaning test-generated files before build..."
        rm -rf src/plugins/generated/ || true
        rm -rf dist/ || true
        mkdir -p src/plugins/generated/
        echo "âœ… Buildæº–å‚™å®Œäº† - ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"

    - name: Build TypeScript
      run: npm run build

    - name: Run quality check
      run: |
        echo "ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        npm run analyze:src
        echo "âœ… å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: Run tests
      env:
        RIMOR_LANG: ja
      run: |
        echo "ğŸ§ª Starting test execution..."
        timeout 300 npm test || {
          echo "âŒ Tests failed or timed out after 5 minutes"
          exit 1
        }
        echo "âœ… Tests completed successfully"


    - name: Clean test artifacts after analysis
      run: |
        echo "ğŸ§¹ Cleaning test-generated files..."
        rm -rf src/plugins/generated/ || true
        find . -name "*.d.ts.map" -type f -delete || true
        find . -name "*.js.map" -type f -delete || true
        echo "âœ… ãƒ†ã‚¹ãƒˆå¾Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Clean generated files before build
      run: |
        echo "ğŸ§¹ Cleaning test-generated files before security check..."
        rm -rf src/plugins/generated/
        mkdir -p src/plugins/generated/
        echo "âœ… Cleanup completed"

    - name: Build TypeScript for security check
      run: npm run build

    - name: Run comprehensive security check
      env:
        RIMOR_LANG: ja
      run: npm run security-check

    - name: Check for outdated packages
      run: npm outdated || true

  publish-dry-run:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Test npm package
      run: npm pack --dry-run

  # PR Quality Gates - Branch Protection Required Check
  quality-gates:
    name: ğŸ“‹ Quality Gates
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run all tests
        run: npm test

      - name: ğŸ“Š Generate test coverage report
        run: |
          echo "ğŸ“Š Generating test coverage report..."
          npm test -- --coverage --coverageReporters=text-summary
          echo "âœ… Coverage report generated"

      - name: ğŸ” TypeScript type checking
        run: |
          echo "ğŸ” Running TypeScript type checking..."
          npx tsc --noEmit
          echo "âœ… Type checking passed"

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate

      - name: ğŸ§¹ Clean test artifacts before build
        run: |
          echo "ğŸ§¹ Cleaning test-generated files before build..."
          rm -rf src/plugins/generated/ || true
          echo "âœ… Build cleanup completed"

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ¯ Run full quality check
        run: npm run full-check

      - name: ğŸ“Š Performance validation
        run: npm test -- --testPathPattern=performance --verbose

      - name: ğŸ” Verify package integrity
        run: |
          echo "ğŸ” Verifying package integrity..."
          npm pack --dry-run
          echo "âœ… Package validation successful"

      - name: ğŸ‰ Quality Gates Passed
        run: |
          echo "ğŸ‰ All Quality Gates passed successfully!"
          echo "âœ… Ready for merge to main branch"