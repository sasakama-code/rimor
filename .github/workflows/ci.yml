name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ã‚¸ãƒ§ãƒ–1: ãƒ“ãƒ«ãƒ‰ã¨åŸºæœ¬æ¤œè¨¼
  build-and-verify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Type check
      run: npx tsc --noEmit

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.node-version }}
        path: dist/
        retention-days: 1

  # ã‚¸ãƒ§ãƒ–2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«è¡›ç”Ÿæ¤œæŸ»ï¼ˆIssue #118å¯¾å¿œï¼‰
  cache-file-hygiene:
    runs-on: ubuntu-latest
    needs: build-and-verify
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºã‚’ç¢ºå®Ÿã«
    
    - name: Cache File Detection (Issue #118)
      run: |
        echo "ğŸ—„ï¸ Checking for cache files and PII exposure risks..."
        
        # Issue #118ã§ç‰¹å®šã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³
        CACHE_PATTERNS=(
          "\.map$"
          "\.d\.ts\.map$" 
          "\.js\.map$"
          "\.css\.map$"
          "\.jest-cache/"
          "\.ts-jest/"
          "\.tsbuildinfo$"
          "\.cache/"
          "\.turbo/"
          "\.nx/cache/"
          "\.vite/cache/"
          "\.parcel-cache/"
          "node_modules\.cache"
          "jest-transform-cache-"
        )
        
        CACHE_FILE_ERRORS=0
        
        # å…¨è¿½è·¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œæŸ»
        TRACKED_FILES=$(git ls-files)
        
        for pattern in "${CACHE_PATTERNS[@]}"; do
          MATCHING_FILES=$(echo "$TRACKED_FILES" | grep -E "$pattern" || true)
          
          if [ -n "$MATCHING_FILES" ]; then
            echo "::error title=Cache File Detected::Pattern '$pattern' matches:"
            echo "$MATCHING_FILES" | sed 's/^/  /' 
            CACHE_FILE_ERRORS=$((CACHE_FILE_ERRORS + 1))
          fi
        done
        
        # PIIéœ²å‡ºãƒªã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹åˆ¥ãƒã‚§ãƒƒã‚¯
        PII_RISK_FILES=$(echo "$TRACKED_FILES" | grep -E "\.(map|log)$" || true)
        if [ -n "$PII_RISK_FILES" ]; then
          echo "::error title=PII Exposure Risk::Following files may contain sensitive information:"
          echo "$PII_RISK_FILES" | sed 's/^/  /'
          CACHE_FILE_ERRORS=$((CACHE_FILE_ERRORS + 1))
        fi
        
        if [ $CACHE_FILE_ERRORS -ne 0 ]; then
          echo ""
          echo "::error title=Issue #118 Cache File Prevention::Cache files detected in repository"
          echo "ğŸ’¡ Resolution steps:"
          echo "  1. Remove files: git rm --cached <filename>"
          echo "  2. Verify .gitignore patterns are correct"
          echo "  3. Check TypeScript sourceMap settings"
          echo "  4. See Issue #118 for details"
          exit 1
        else
          echo "âœ… Cache file hygiene check passed"
        fi
    
    - name: Generate Cache File Report
      if: always()
      run: |
        mkdir -p .rimor/reports/security/
        cat > .rimor/reports/security/cache-file-hygiene-report.json << EOF
        {
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "issue": "118",
          "status": "$([ $CACHE_FILE_ERRORS -eq 0 ] && echo 'PASS' || echo 'FAIL')",
          "description": "Automated cache file detection and PII exposure risk assessment",
          "filesChecked": $(git ls-files | wc -l),
          "violationsFound": $CACHE_FILE_ERRORS,
          "riskLevel": "$([ $CACHE_FILE_ERRORS -eq 0 ] && echo 'LOW' || echo 'HIGH')"
        }
        EOF
    
    - name: Upload Cache File Hygiene Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cache-file-hygiene-report
        path: .rimor/reports/security/cache-file-hygiene-report.json
        retention-days: 30

  # ã‚¸ãƒ§ãƒ–3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆTaintTyperå«ã‚€ï¼‰
  security-audit:
    runs-on: ubuntu-latest
    needs: cache-file-hygiene
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-20.x
        path: dist/

    - name: Run comprehensive security check
      run: npm run security-check

    - name: Upload security audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-results
        path: |
          .rimor/reports/security/audit-results.json
          .rimor/reports/security/security-analysis-report.json
        if-no-files-found: ignore

  # ã‚¸ãƒ§ãƒ–4: å“è³ªç›£æŸ»ï¼ˆdogfoodingï¼‰
  quality-audit:
    runs-on: ubuntu-latest
    needs: build-and-verify
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-20.x
        path: dist/

    - name: Run quality audit (dogfooding)
      run: |
        # æ–°ã—ã„å“è³ªç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        if [ -f scripts/quality-audit.js ]; then
          node scripts/quality-audit.js
        else
          # æš«å®šçš„ã«æ—¢å­˜ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          mkdir -p .rimor/reports/quality
          npm run analyze:src:json > .rimor/reports/quality/quality-audit-results.json
          ANALYSIS_EXIT_CODE=$?
          
          if [ "$ANALYSIS_EXIT_CODE" -gt 1 ]; then
            echo "::error::Quality audit failed with exit code $ANALYSIS_EXIT_CODE"
            exit 1
          fi
          
          # çµæœã®åˆ†æ
          if [ -f .rimor/reports/quality/quality-audit-results.json ]; then
            if ! jq empty .rimor/reports/quality/quality-audit-results.json 2>/dev/null; then
              echo "::error::Invalid JSON in quality-audit-results.json"
              exit 1
            fi
            
            TOTAL_ISSUES=$(jq '.issues | length' .rimor/reports/quality/quality-audit-results.json)
            echo "Total quality issues found: $TOTAL_ISSUES"
            
            # å“è³ªã‚¹ã‚³ã‚¢ã®è¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if jq -e '.qualityScore' .rimor/reports/quality/quality-audit-results.json >/dev/null 2>&1; then
              QUALITY_SCORE=$(jq '.qualityScore' .rimor/reports/quality/quality-audit-results.json)
              echo "Overall quality score: $QUALITY_SCORE"
            fi
          fi
        fi

    - name: Upload quality audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-audit-results
        path: |
          .rimor/reports/quality/quality-audit-results.json
          .rimor/reports/quality/dogfooding-report.json
        if-no-files-found: ignore

  # ã‚¸ãƒ§ãƒ–5: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    needs: [security-audit, quality-audit]
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ matrix.node-version }}
        path: dist/

    - name: Run tests
      env:
        NODE_OPTIONS: '--max-old-space-size=2048'
        DISABLE_SECURITY_VALIDATION_LOGS: 'true'
      run: npm test

    - name: Upload AI Error Report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ai-error-report-${{ matrix.node-version }}
        path: |
          .rimor/reports/test-errors-ai.md
          .rimor/reports/test-errors-ai.json

    - name: Post AI Error Report Summary to PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true
      env:
        NODE_VERSION: ${{ matrix.node-version }}
      with:
        script: |
          const fs = require('fs');
          const summaryPath = '.rimor/reports/test-errors-ai-summary.md';
          
          if (fs.existsSync(summaryPath)) {
            const summary = fs.readFileSync(summaryPath, 'utf8');
            
            // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const artifactsMessage = `\n\nğŸ“ **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: [ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ](${runUrl})ã‹ã‚‰ \`ai-error-report-${process.env.NODE_VERSION}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            
            const body = `## ğŸ¤– AI Error Report (Node.js ${process.env.NODE_VERSION})\n\n${summary}${artifactsMessage}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
          }

  # npmå…¬é–‹ã®æº–å‚™ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  publish-dry-run:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-20.x
        path: dist/

    - name: Test npm package
      run: npm pack --dry-run

  # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã¨ãƒã‚§ãƒƒã‚¯
  coverage:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Run tests with coverage
      run: npm run test:coverage:ci
      continue-on-error: true

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/

    - name: Comment coverage report on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          const coverageScript = require('./scripts/coverage-comment');
          await coverageScript.postCoverageComment({ github, core, context });