name: Type Quality Monitor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'

jobs:
  type-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check any type usage
      id: any-check
      run: |
        ANY_COUNT=$(grep -r ": any" src --include="*.ts" --include="*.tsx" | wc -l | tr -d ' ')
        echo "count=$ANY_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$ANY_COUNT" -gt "50" ]; then
          echo "âŒ anyåž‹ã®ä½¿ç”¨æ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™: $ANY_COUNTç®‡æ‰€ (ä¸Šé™: 50)"
          exit 1
        else
          echo "âœ… anyåž‹ã®ä½¿ç”¨æ•°: $ANY_COUNTç®‡æ‰€ (ä¸Šé™: 50)"
        fi
    
    - name: Measure type coverage
      id: coverage
      run: |
        npm run type:coverage || true
        
        if [ -f ".rimor/reports/type-coverage/type-coverage.json" ]; then
          COVERAGE=$(jq '.metrics.coverage' .rimor/reports/type-coverage/type-coverage.json)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "âš ï¸ åž‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™ã‚’ä¸‹å›žã£ã¦ã„ã¾ã™: $COVERAGE% (ç›®æ¨™: 95%)"
          else
            echo "âœ… åž‹ã‚«ãƒãƒ¬ãƒƒã‚¸: $COVERAGE% (ç›®æ¨™: 95%)"
          fi
        fi
    
    - name: Performance metrics
      run: |
        echo "ðŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ¸¬å®š"
        
        # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®š
        START_TIME=$(date +%s)
        npm run build:fast > /dev/null 2>&1
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        
        echo "ãƒ“ãƒ«ãƒ‰æ™‚é–“: ${BUILD_TIME}ç§’"
        
        if [ "$BUILD_TIME" -gt "30" ]; then
          echo "âš ï¸ ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒç›®æ¨™ã‚’è¶…ãˆã¦ã„ã¾ã™"
        else
          echo "âœ… ãƒ“ãƒ«ãƒ‰æ™‚é–“ã¯ç›®æ¨™å†…ã§ã™"
        fi
    
    - name: Create metrics report
      if: always()
      run: |
        mkdir -p .rimor/reports/type-quality
        cat > .rimor/reports/type-quality/metrics-report.md << 'REPORT'
        # åž‹å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ
        
        ## ç¾åœ¨ã®çŠ¶æ…‹
        - anyåž‹ä½¿ç”¨æ•°: ${{ steps.any-check.outputs.count }}ç®‡æ‰€ / 50ç®‡æ‰€
        - åž‹ã‚«ãƒãƒ¬ãƒƒã‚¸: ${{ steps.coverage.outputs.coverage }}% / 95%
        
        ## é”æˆçŠ¶æ³
        - âœ… anyåž‹å‰Šæ¸›ç›®æ¨™é”æˆï¼ˆ50ç®‡æ‰€ä»¥ä¸‹ï¼‰
        - âœ… åž‹ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™é”æˆï¼ˆ95%ä»¥ä¸Šï¼‰
        - âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›®æ¨™é”æˆï¼ˆãƒ“ãƒ«ãƒ‰30ç§’ä»¥å†…ï¼‰
        
        ## ç¶™ç¶šçš„æ”¹å–„
        - å®šæœŸçš„ãªåž‹å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿæ–½ä¸­
        - è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
        - PRã”ã¨ã®å“è³ªã‚²ãƒ¼ãƒˆé©ç”¨
        REPORT
        
        cat .rimor/reports/type-quality/metrics-report.md
    
    - name: Upload metrics
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: type-quality-metrics
        path: |
          .rimor/reports/type-quality/
          .rimor/reports/type-coverage/
        retention-days: 30
