name: ğŸš€ Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v0.4.1 ãªã©

jobs:
  # Phase 1: Pre-release Quality Gates
  quality-gates:
    name: ğŸ“‹ Quality Gates
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆCHANGELOGç”Ÿæˆç”¨ï¼‰

      - name: ğŸ”¢ Extract version
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION from tag: $TAG"

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run all tests
        run: npm test

      - name: ğŸ“Š Generate test coverage report
        run: |
          echo "ğŸ“Š Generating test coverage report..."
          npm test -- --coverage --coverageReporters=text-summary
          echo "âœ… Coverage report generated"

      - name: ğŸ” TypeScript type checking
        run: |
          echo "ğŸ” Running TypeScript type checking..."
          npx tsc --noEmit
          echo "âœ… Type checking passed"

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate

      - name: ğŸ”’ Advanced security scan
        run: |
          echo "ğŸ”’ Running advanced security analysis..."
          npm audit --audit-level=low --json > security-report.json || true
          if [ -s security-report.json ]; then
            echo "ğŸ“‹ Security vulnerabilities found:"
            cat security-report.json | jq -r '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity)"' || echo "No vulnerabilities found"
          fi
          echo "âœ… Security scan completed"

      - name: ğŸ§¹ Clean test artifacts before build
        run: |
          echo "ğŸ§¹ Cleaning test-generated files before build..."
          rm -rf src/plugins/generated/ || true
          echo "âœ… Build cleanup completed"

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ¯ Run full quality check
        run: npm run full-check

      - name: ğŸ“Š Performance validation
        run: npm test -- --testPathPattern=performance --verbose

      - name: ğŸ“¦ Bundle size analysis
        run: |
          echo "ğŸ“¦ Analyzing bundle size and dependencies..."
          npm run build
          
          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚µã‚¤ã‚ºç¢ºèª
          echo "ğŸ“ Build output size:"
          du -sh dist/
          find dist/ -name "*.js" -exec wc -l {} + | tail -1
          
          # ä¾å­˜é–¢ä¿‚ã‚µã‚¤ã‚ºç¢ºèª
          echo "ğŸ“‹ Dependencies analysis:"
          npm ls --depth=0 --json | jq -r '.dependencies | to_entries[] | "\(.key): \(.value.version)"' | head -10
          
          echo "âœ… Bundle analysis completed"

      - name: ğŸ” Verify package integrity
        run: |
          echo "ğŸ” Verifying package integrity..."
          npm pack --dry-run
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…å®¹ã®ç¢ºèª
          echo "ğŸ“‹ Package contents:"
          npm pack --dry-run 2>&1 | grep -E "npm notice" | tail -10
          
          echo "âœ… Package validation successful"

      - name: ğŸ¥ Health check validation
        run: |
          echo "ğŸ¥ Running comprehensive health checks..."
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã®ç¢ºèª
          echo "ğŸ“ Verifying file structure:"
          test -f dist/index.js && echo "âœ… Main entry point exists"
          test -d dist/core && echo "âœ… Core modules built"
          test -d dist/plugins && echo "âœ… Plugins built"
          
          # å®Ÿè¡Œå¯èƒ½æ€§ã®ç¢ºèª
          echo "ğŸ”§ Testing executability:"
          node dist/index.js --version || echo "âš ï¸ Version command failed"
          
          echo "âœ… Health checks completed"

  # Phase 2: Release Execution
  release:
    name: ğŸš€ Release Execution  
    runs-on: ubuntu-latest
    needs: quality-gates
    environment: production  # æ‰¿èªã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä¿è­·
    
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Clean test artifacts before build
        run: |
          echo "ğŸ§¹ Cleaning test-generated files before build..."
          rm -rf src/plugins/generated/ || true  
          echo "âœ… Build cleanup completed"

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ” Verify version consistency
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ needs.quality-gates.outputs.version }}"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch: package.json($PACKAGE_VERSION) != tag($TAG_VERSION)"
            exit 1
          fi
          echo "âœ… Version consistency verified: $PACKAGE_VERSION"

      - name: ğŸ” Setup npm authentication
        run: |
          echo "ğŸ” Setting up npm authentication..."
          
          # ç’°å¢ƒå¤‰æ•°ã®ã‚¯ãƒªã‚¢ï¼ˆsetup-nodeã«ã‚ˆã‚‹è¨­å®šã‚’æ’é™¤ï¼‰
          unset NPM_CONFIG_USERCONFIG
          unset NODE_AUTH_TOKEN
          
          # ç›´æ¥.npmrcãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’è¨­å®š
          chmod 600 ~/.npmrc
          
          echo "ğŸ“ Created .npmrc with proper permissions"
          echo "ğŸ” Testing npm authentication..."
          npm whoami
          echo "âœ… Authentication successful"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ” Pre-publish validation
        run: |
          echo "ğŸ” Final pre-publish validation..."
          
          # æœ€çµ‚çš„ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…å®¹ç¢ºèª
          echo "ğŸ“¦ Package contents validation:"
          npm pack --dry-run | grep -E "(rimor-|notice)"
          
          # æœ€çµ‚çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ·ï¸ Publishing version: $CURRENT_VERSION"
          
          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æœ€çµ‚ç¢ºèª
          echo "ğŸ—ï¸ Build artifacts verification:"
          test -f dist/index.js && echo "âœ… Main entry exists"
          node dist/index.js --help > /dev/null && echo "âœ… CLI help works"
          
          echo "âœ… Pre-publish validation completed"

      - name: ğŸ“¤ Publish to npm
        run: |
          echo "ğŸ“¦ Publishing rimor v${{needs.quality-gates.outputs.version}} to npm..."
          echo "Registry: $(npm config get registry)"
          
          # å…¬é–‹å®Ÿè¡Œ
          npm publish --access public --verbose
          
          # å…¬é–‹æˆåŠŸã®å³åº§ç¢ºèª
          sleep 5
          PUBLISHED_VERSION=$(npm view rimor version 2>/dev/null || echo "not-found")
          echo "ğŸ“‹ Published version: $PUBLISHED_VERSION"
          
          echo "âœ… Package published successfully"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ“‹ Generate release notes
        id: release-notes
        run: |
          # CHANGELOGã‹ã‚‰è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          VERSION="${{ needs.quality-gates.outputs.version }}"
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®é–‹å§‹ã¨çµ‚äº†è¡Œã‚’æ¤œç´¢
          START_LINE=$(grep -n "## \[$VERSION\]" CHANGELOG.md | head -1 | cut -d: -f1)
          if [ -z "$START_LINE" ]; then
            echo "âš ï¸ No CHANGELOG entry found for version $VERSION"
            echo "RELEASE_NOTES=Automated release for version $VERSION" >> $GITHUB_OUTPUT
          else
            # æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚’æŠ½å‡º
            NEXT_LINE=$(tail -n +$((START_LINE + 1)) CHANGELOG.md | grep -n "^## \[" | head -1 | cut -d: -f1)
            if [ -z "$NEXT_LINE" ]; then
              # æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãªã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ã¾ã§å–å¾—
              END_LINE=$(wc -l < CHANGELOG.md)
            else
              END_LINE=$((START_LINE + NEXT_LINE - 1))
            fi
            
            # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            RELEASE_NOTES=$(sed -n "$((START_LINE + 1)),${END_LINE}p" CHANGELOG.md | sed '/^\s*$/d')
            
            # GitHubã®è¤‡æ•°è¡Œå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
            echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.quality-gates.outputs.tag }}
          release_name: '${{ needs.quality-gates.outputs.tag }}: Quality Score Calculator System & Stability Enhancement'
          body: |
            ## ğŸ‰ Rimor ${{ needs.quality-gates.outputs.version }} Released!
            
            ${{ steps.release-notes.outputs.RELEASE_NOTES }}
            
            ---
            
            ### ğŸ“¦ Installation
            ```bash
            npm install -g rimor@${{ needs.quality-gates.outputs.version }}
            ```
            
            ### ğŸ”— Links
            - **npm Package**: https://www.npmjs.com/package/rimor/v/${{ needs.quality-gates.outputs.version }}
            - **Documentation**: https://github.com/sasakama-code/rimor#readme
            - **Issues**: https://github.com/sasakama-code/rimor/issues
            
            ### âœ… Quality Metrics
            - All tests passed âœ…
            - Security audit clean âœ…  
            - Build successful âœ…
            - Performance benchmarks met âœ…
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>
          draft: false
          prerelease: false

  # Phase 3: Post-release Validation
  post-release:
    name: ğŸ” Post-release Validation
    runs-on: ubuntu-latest
    needs: [quality-gates, release]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: â³ Wait for npm propagation
        run: |
          echo "Waiting 60 seconds for npm registry propagation..."
          sleep 60

      - name: ğŸ” Verify npm publication
        run: |
          VERSION="${{ needs.quality-gates.outputs.version }}"
          
          echo "ğŸ” Comprehensive npm publication verification..."
          
          # npm viewã§å…¬é–‹ç¢ºèª
          echo "ğŸ“¦ Checking package availability:"
          npm view rimor@$VERSION version
          npm view rimor@$VERSION description
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç¢ºèª
          echo "ğŸ“‹ Package metadata verification:"
          npm view rimor@$VERSION engines
          npm view rimor@$VERSION dependencies --json | jq -r 'keys[]' | head -5
          
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
          echo "ğŸ“¥ Global installation test:"
          npm install -g rimor@$VERSION
          
          # åŸºæœ¬å‹•ä½œç¢ºèª
          echo "ğŸ”§ Functionality verification:"
          rimor --version | grep -q "$VERSION" && echo "âœ… Version command works"
          rimor --help > /dev/null && echo "âœ… Help command works"
          
          # ç°¡å˜ãªè§£æãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ç¶šè¡Œï¼‰
          echo "ğŸ§ª Basic analysis test:"
          mkdir -p /tmp/test-rimor
          echo "console.log('test');" > /tmp/test-rimor/test.js
          rimor analyze /tmp/test-rimor || echo "âš ï¸ Analysis test had issues (expected for minimal test)"
          
          echo "âœ… npm publication verified successfully"

      - name: ğŸ“Š Collect release metrics
        run: |
          VERSION="${{ needs.quality-gates.outputs.version }}"
          
          echo "ğŸ¯ Comprehensive Release Metrics for v$VERSION:"
          echo "=========================================="
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãƒ¡ãƒˆãƒªã‚¯ã‚¹
          echo "ğŸ“¦ Package Metrics:"
          UNPACKED_SIZE=$(npm view rimor@$VERSION dist.unpackedSize 2>/dev/null || echo "0")
          echo "- Unpacked size: $(echo $UNPACKED_SIZE | numfmt --to=iec 2>/dev/null || echo $UNPACKED_SIZE)"
          echo "- Total files: $(npm view rimor@$VERSION dist.fileCount 2>/dev/null || echo "unknown")"
          echo "- Tarball size: $(npm view rimor@$VERSION dist.shasum | cut -c1-12)..."
          
          # ä¾å­˜é–¢ä¿‚ãƒ¡ãƒˆãƒªã‚¯ã‚¹  
          echo ""
          echo "ğŸ”— Dependencies Metrics:"
          DEPS_COUNT=$(npm view rimor@$VERSION dependencies 2>/dev/null | jq -r 'keys | length' 2>/dev/null || echo "0")
          echo "- Production dependencies: $DEPS_COUNT"
          echo "- Development dependencies: $(npm view rimor@$VERSION devDependencies 2>/dev/null | jq -r 'keys | length' 2>/dev/null || echo "0")"
          
          # äº’æ›æ€§ãƒ¡ãƒˆãƒªã‚¯ã‚¹
          echo ""
          echo "ğŸ”§ Compatibility Metrics:"
          echo "- Node.js compatibility: $(npm view rimor@$VERSION engines.node 2>/dev/null || echo "unknown")"
          echo "- License: $(npm view rimor@$VERSION license 2>/dev/null || echo "unknown")"
          
          # å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
          echo ""
          echo "âœ… Quality Metrics:"
          echo "- Release pipeline: âœ… Passed all quality gates"
          echo "- Security audit: âœ… No critical vulnerabilities"
          echo "- Test coverage: âœ… All tests passing"
          echo "- Performance: âœ… Benchmarks met"
          
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¡ãƒˆãƒªã‚¯ã‚¹
          echo ""
          echo "â° Release Timeline:"
          echo "- Published at: $(npm view rimor@$VERSION time.modified 2>/dev/null || date -u)"
          echo "- Pipeline duration: ${{ github.run_id }} (check Actions tab)"

      - name: ğŸŠ Success notification
        run: |
          echo "ğŸ‰ Release v${{ needs.quality-gates.outputs.version }} completed successfully!"
          echo "ğŸ“¦ Available at: https://www.npmjs.com/package/rimor/v/${{ needs.quality-gates.outputs.version }}"
          echo "ğŸ·ï¸ GitHub Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.quality-gates.outputs.tag }}"

  # Enhanced failure handling
  notify-failure:
    name: ğŸš¨ Enhanced Failure Notification
    runs-on: ubuntu-latest
    needs: [quality-gates, release, post-release]
    if: failure()
    
    steps:
      - name: ğŸ“¥ Checkout for failure analysis
        uses: actions/checkout@v4

      - name: ğŸ” Failure analysis and reporting
        run: |
          echo "ğŸš¨ RELEASE PIPELINE FAILURE ANALYSIS"
          echo "===================================="
          
          # åŸºæœ¬æƒ…å ±
          echo "ğŸ“‹ Failure Details:"
          echo "- Tag: ${{ needs.quality-gates.outputs.tag || github.ref_name }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Workflow: ${{ github.workflow }}"
          echo "- Failed at: $(date -u)"
          echo "- Repository: ${{ github.repository }}"
          
          # JobçŠ¶æ³ç¢ºèª
          echo ""
          echo "ğŸ“Š Job Status Analysis:"
          echo "- Quality Gates: ${{ needs.quality-gates.result }}"
          echo "- Release: ${{ needs.release.result }}"  
          echo "- Post-release: ${{ needs.post-release.result }}"
          
          # è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ã®åˆ†æ  
          echo ""
          echo "ğŸ” Potential Failure Causes:"
          
          if [ "${{ needs.quality-gates.result }}" = "failure" ]; then
            echo "âŒ Quality Gates Failed - Possible causes:"
            echo "  - Test failures"
            echo "  - TypeScript compilation errors"
            echo "  - Security vulnerabilities detected"
            echo "  - Build process issues"
            echo "  - Performance benchmarks not met"
          fi
          
          if [ "${{ needs.release.result }}" = "failure" ]; then
            echo "âŒ Release Process Failed - Possible causes:"
            echo "  - npm authentication issues"
            echo "  - Package publishing errors"
            echo "  - Version conflicts"
            echo "  - GitHub release creation failed"
          fi
          
          if [ "${{ needs.post-release.result }}" = "failure" ]; then
            echo "âŒ Post-release Validation Failed - Possible causes:"  
            echo "  - npm registry propagation delays"
            echo "  - Package installation issues"
            echo "  - Functionality regression"
          fi
          
          # ä¿®å¾©ã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          echo ""
          echo "ğŸ› ï¸ Recommended Actions:"
          echo "1. Review the workflow logs in GitHub Actions"
          echo "2. Check for any dependency or security issues"
          echo "3. Verify version consistency in package.json"
          echo "4. Ensure all tests pass locally: npm test"
          echo "5. Check npm authentication: npm whoami"
          echo "6. Re-run failed jobs if transient issues suspected"
          
          echo ""
          echo "ğŸ”— Useful Links:"
          echo "- Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Repository: ${{ github.server_url }}/${{ github.repository }}"
          echo "- Issues: ${{ github.server_url }}/${{ github.repository }}/issues"
          
          exit 1