name: ðŸ¥ Release Health Monitor

on:
  schedule:
    # æ¯Žæ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã¨åˆå¾Œ9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0,12 * * *'  # UTC: 00:00, 12:00 = JST: 09:00, 21:00
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      detailed_check:
        description: 'Run detailed health analysis'
        required: false
        default: 'false'
        type: boolean

jobs:
  health-monitor:
    name: ðŸ” Health Status Monitor
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write  # Issueä½œæˆæ¨©é™ï¼ˆå•é¡Œæ¤œå‡ºæ™‚ï¼‰
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ¥ Run health check
        id: health-check
        run: |
          echo "ðŸ¥ Running Rimor Release Health Check..."
          node scripts/release-health-check.js > health-report.txt 2>&1
          HEALTH_STATUS=$?
          
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          
          # çµæžœã‚’GitHub Outputã«ä¿å­˜
          if [ $HEALTH_STATUS -eq 0 ]; then
            echo "result=healthy" >> $GITHUB_OUTPUT
          else
            echo "result=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’ç¢ºèª
          cat health-report.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ðŸ“Š Upload health report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: health-report-${{ github.run_number }}
          path: health-report.txt
          retention-days: 30

      - name: ðŸš¨ Create issue on critical failure
        if: steps.health-check.outputs.result == 'unhealthy'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const healthReport = fs.readFileSync('health-report.txt', 'utf8');
            
            const issueTitle = `ðŸš¨ Release Health Check Failed - ${new Date().toISOString().split('T')[0]}`;
            const issueBody = `## ðŸš¨ Critical Health Issues Detected
            
            **Detected at:** ${new Date().toLocaleString()}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### ðŸ“‹ Health Report
            \`\`\`
            ${healthReport}
            \`\`\`
            
            ### ðŸ› ï¸ Immediate Actions Required
            
            1. **Check npm package availability**
               - Verify package can be installed: \`npm install -g rimor\`
               - Test CLI functionality: \`rimor --version\`
            
            2. **Review recent releases**
               - Check latest release: https://github.com/${{ github.repository }}/releases/latest
               - Verify GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions
            
            3. **Monitor user reports**
               - Check for new issues: ${{ github.server_url }}/${{ github.repository }}/issues
               - Review npm download statistics
            
            ### ðŸ”— Useful Commands
            \`\`\`bash
            # Manual health check
            npm run health-check
            
            # Check package status
            npm view rimor
            
            # Test installation
            npm install -g rimor@latest
            rimor --version
            \`\`\`
            
            **Auto-generated by Release Health Monitor**
            `;
            
            // æ—¢å­˜ã®å¥åº·ãƒã‚§ãƒƒã‚¯é–¢é€£IssueãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,critical'
            });
            
            // 24æ™‚é–“ä»¥å†…ã®å¥åº·ãƒã‚§ãƒƒã‚¯issueãŒãªã„å ´åˆã®ã¿ä½œæˆ
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const recentHealthIssues = existingIssues.data.filter(issue => 
              new Date(issue.created_at) > oneDayAgo && 
              issue.title.includes('Release Health Check Failed')
            );
            
            if (recentHealthIssues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['health-check', 'critical', 'automated']
              });
              
              console.log('ðŸš¨ Critical health issue created');
            } else {
              console.log('âš ï¸ Recent health issue already exists, skipping creation');
            }

      - name: ðŸ’¬ Add comment to existing issue
        if: steps.health-check.outputs.result == 'unhealthy'
        uses: actions/github-script@v6
        with:
          script: |
            // æœ€æ–°ã®å¥åº·ãƒã‚§ãƒƒã‚¯issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,critical',
              sort: 'created',
              direction: 'desc',
              per_page: 1
            });
            
            if (existingIssues.data.length > 0) {
              const latestIssue = existingIssues.data[0];
              const commentBody = `### ðŸ“Š Health Check Update - ${new Date().toLocaleString()}
              
              ðŸš¨ Health check failed again.
              
              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Report Artifact:** [health-report-${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              Please investigate and resolve the underlying issues.`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: latestIssue.number,
                body: commentBody
              });
            }

      - name: âœ… Health check success notification
        if: steps.health-check.outputs.result == 'healthy'
        run: |
          echo "ðŸŽ‰ Health check passed successfully!"
          echo "ðŸ“Š All systems operational"
          echo "ðŸ”— Report available in artifacts"
          
          # Slack notification (optional)
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"âœ… Rimor health check passed at '"$(date)"'"}' \
          #   $SLACK_WEBHOOK_URL

  # Extended monitoring job (runs less frequently)
  extended-monitoring:
    name: ðŸ“ˆ Extended Health Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.detailed_check == 'true' || github.event.schedule
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“ˆ Collect extended metrics
        run: |
          echo "ðŸ“ˆ Extended Health Metrics Collection"
          echo "===================================="
          
          # Package download trends
          echo "ðŸ“Š NPM Download Analysis:"
          PACKAGE_STATS=$(curl -s "https://api.npmjs.org/downloads/range/last-month/rimor" || echo '{"error": "API unavailable"}')
          echo "$PACKAGE_STATS" | jq -r '.downloads[]? | "\(.day): \(.downloads) downloads"' | tail -7 || echo "Download data unavailable"
          
          # Repository activity
          echo ""  
          echo "ðŸ™ Repository Activity:"
          echo "- Commits (last 30 days): $(git log --since='30 days ago' --oneline | wc -l)"
          echo "- Contributors (last 30 days): $(git log --since='30 days ago' --format='%ae' | sort -u | wc -l)"
          
          # Size analysis
          echo ""
          echo "ðŸ“¦ Package Size Analysis:"
          npm pack --dry-run 2>&1 | grep -E "(npm notice|total files|unpacked size)" || echo "Size analysis unavailable"
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Generate weekly summary
        if: github.event.schedule && contains(github.event.schedule, '0 0')  # Daily midnight run only
        run: |
          echo "ðŸ“Š Weekly Health Summary - $(date +%Y-%m-%d)"
          echo "========================================="
          
          # This could be expanded to generate comprehensive weekly reports
          echo "ðŸŽ¯ Key Metrics:"
          echo "- Health checks this week: Tracked in Actions history"
          echo "- Package stability: Monitor via npm statistics"
          echo "- Issue resolution rate: Track via GitHub Issues"
          
          echo ""
          echo "ðŸ“‹ Recommendations:"
          echo "- Continue regular monitoring"
          echo "- Review any recurring issues"
          echo "- Update health check thresholds if needed"