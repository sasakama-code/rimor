name: Type Check & Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ã«å®Ÿè¡Œï¼ˆJST 11:00ï¼‰
    - cron: '0 17 * * *'

jobs:
  type-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build TypeScript
      run: npm run build:simple
      continue-on-error: true
    
    - name: Type Check with strict mode
      run: npx tsc --noEmit --strict
      continue-on-error: true
    
    - name: Measure Type Coverage
      id: type-coverage
      run: |
        node scripts/type-coverage.js || true
        
        # çµæœã‚’GitHub Outputã«ä¿å­˜
        if [ -f ".rimor/reports/type-coverage/type-coverage.json" ]; then
          COVERAGE=$(jq '.metrics.coverage' .rimor/reports/type-coverage/type-coverage.json)
          ANY_COUNT=$(jq '.metrics.totalAnyUsages' .rimor/reports/type-coverage/type-coverage.json)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "any_count=$ANY_COUNT" >> $GITHUB_OUTPUT
        fi
    
    - name: Check Circular Dependencies
      id: circular-deps
      run: |
        node scripts/check-circular-deps.js || true
        
        if [ -f ".rimor/reports/dependencies/circular-deps.json" ]; then
          CIRCULAR_COUNT=$(jq '.circularDependencies | length' .rimor/reports/dependencies/circular-deps.json)
          echo "circular_count=$CIRCULAR_COUNT" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload Type Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: type-coverage-report
        path: |
          .rimor/reports/type-coverage/
          .rimor/reports/dependencies/
        retention-days: 30
    
    - name: Comment PR with Type Metrics
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.type-coverage.outputs.coverage }}' || 'N/A';
          const anyCount = '${{ steps.type-coverage.outputs.any_count }}' || 'N/A';
          const circularCount = '${{ steps.circular-deps.outputs.circular_count }}' || '0';
          
          const comment = `## ğŸ” å‹å“è³ªãƒ¬ãƒãƒ¼ãƒˆ
          
          ### ãƒ¡ãƒˆãƒªã‚¯ã‚¹
          | é …ç›® | å€¤ | ç›®æ¨™ | çŠ¶æ…‹ |
          |------|-----|------|------|
          | å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ | ${coverage}% | 95% | ${coverage >= 95 ? 'âœ…' : 'âš ï¸'} |
          | anyå‹ä½¿ç”¨æ•° | ${anyCount} | <50 | ${anyCount < 50 ? 'âœ…' : 'âŒ'} |
          | å¾ªç’°å‚ç…§ | ${circularCount} | 0 | ${circularCount == 0 ? 'âœ…' : 'âŒ'} |
          
          ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          ${anyCount > 50 ? '- anyå‹ã‚’æ®µéšçš„ã«unknownå‹ã«ç§»è¡Œã—ã¦ãã ã•ã„' : ''}
          ${circularCount > 0 ? '- å¾ªç’°å‚ç…§ã‚’è§£æ¶ˆã—ã¦ãã ã•ã„' : ''}
          ${coverage < 95 ? '- å‹å®šç¾©ã‚’å¼·åŒ–ã—ã¦ãã ã•ã„' : ''}
          
          è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã”ç¢ºèªãã ã•ã„ã€‚`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: comment
          });
    
    - name: Create Type Coverage Badge
      if: github.ref == 'refs/heads/main'
      run: |
        COVERAGE="${{ steps.type-coverage.outputs.coverage }}"
        COLOR="red"
        
        if [ "$(echo "$COVERAGE >= 95" | bc)" -eq 1 ]; then
          COLOR="green"
        elif [ "$(echo "$COVERAGE >= 90" | bc)" -eq 1 ]; then
          COLOR="yellow"
        elif [ "$(echo "$COVERAGE >= 80" | bc)" -eq 1 ]; then
          COLOR="orange"
        fi
        
        echo "Type Coverage: $COVERAGE% - Color: $COLOR"
    
  any-reduction:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Auto-convert any to unknown (dry-run)
      run: |
        echo "ğŸ”„ Analyzing any type usage for auto-conversion..."
        node scripts/convert-any-to-unknown.js src --dry-run > conversion-report.txt
        
        if grep -q "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: [1-9]" conversion-report.txt; then
          echo "ğŸ“ Potential any to unknown conversions found"
          cat conversion-report.txt
          
          # Create an issue if conversions are possible
          echo "TODO: Create GitHub issue for any type reduction"
        else
          echo "âœ… No any type conversions needed"
        fi
    
    - name: Upload Conversion Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: any-conversion-report
        path: |
          conversion-report.txt
          .rimor/reports/type-migration/
        retention-days: 7

  quality-gate:
    runs-on: ubuntu-latest
    needs: [type-coverage]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Check Quality Gates
      run: |
        COVERAGE="${{ needs.type-coverage.outputs.coverage }}"
        ANY_COUNT="${{ needs.type-coverage.outputs.any_count }}"
        CIRCULAR_COUNT="${{ needs.type-coverage.outputs.circular_count }}"
        
        FAILED=false
        
        # å‹ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
        if [ "$(echo "$COVERAGE < 95" | bc)" -eq 1 ]; then
          echo "âš ï¸ Warning: Type coverage is below 95% (current: $COVERAGE%)"
        fi
        
        # anyå‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ï¼šå¢—åŠ ã—ãŸå ´åˆï¼‰
        if [ "$ANY_COUNT" -gt "560" ]; then
          echo "âŒ Error: any type usage has increased (current: $ANY_COUNT, limit: 560)"
          FAILED=true
        fi
        
        # å¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ï¼šæ–°è¦è¿½åŠ ï¼‰
        if [ "$CIRCULAR_COUNT" -gt "1" ]; then
          echo "âŒ Error: New circular dependencies detected (current: $CIRCULAR_COUNT)"
          FAILED=true
        fi
        
        if [ "$FAILED" = true ]; then
          echo "âŒ Type quality gates failed"
          exit 1
        else
          echo "âœ… Type quality gates passed"
        fi