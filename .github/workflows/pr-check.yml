name: PR Required Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

jobs:
  # å¿…é ˆãƒã‚§ãƒƒã‚¯1: åž‹ãƒã‚§ãƒƒã‚¯
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run type check
      run: npx tsc --noEmit
    
    - name: Set status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.payload.pull_request.head.sha,
            state: status,
            context: 'Type Check',
            description: status === 'success' ? 'All type checks passed' : 'Type check failed'
          });

  # å¿…é ˆãƒã‚§ãƒƒã‚¯2: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      run: npm test -- --coverage --coverageReporters=json-summary
      continue-on-error: true
    
    - name: Generate coverage report
      if: always()
      run: |
        if [ -f coverage/coverage-summary.json ]; then
          COVERAGE=$(node -e "
            const coverage = require('./coverage/coverage-summary.json');
            const pct = coverage.total.statements.pct;
            console.log(pct);
          ")
          echo "COVERAGE_PCT=$COVERAGE" >> $GITHUB_ENV
          
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::warning::Coverage is below 80% threshold: $COVERAGE%"
            echo "COVERAGE_STATUS=failure" >> $GITHUB_ENV
          else
            echo "Coverage: $COVERAGE%"
            echo "COVERAGE_STATUS=success" >> $GITHUB_ENV
          fi
        else
          echo "COVERAGE_PCT=0" >> $GITHUB_ENV
          echo "COVERAGE_STATUS=failure" >> $GITHUB_ENV
        fi
    
    - name: Comment PR with coverage
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = process.env.COVERAGE_PCT || '0';
          const status = process.env.COVERAGE_STATUS || 'failure';
          
          const comment = `## ðŸ“Š Test Coverage Report
          
          **Coverage**: ${coverage}%
          **Status**: ${status === 'success' ? 'âœ… Passing' : 'âŒ Below threshold (80%)'}
          
          ${status === 'failure' ? 'âš ï¸ Please improve test coverage before merging.' : ''}`;
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Test Coverage Report')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

  # å¿…é ˆãƒã‚§ãƒƒã‚¯3: ãƒ“ãƒ«ãƒ‰æˆåŠŸ
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run build
      run: npm run build
    
    - name: Verify build output
      run: |
        if [ ! -d "dist" ]; then
          echo "::error::Build output directory 'dist' not found"
          exit 1
        fi
        
        if [ ! -f "dist/index.js" ]; then
          echo "::error::Main entry point 'dist/index.js' not found"
          exit 1
        fi

  # å¿…é ˆãƒã‚§ãƒƒã‚¯4: Linting
  lint-check:
    name: Lint Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npx eslint src test --ext .ts,.tsx --max-warnings 0
      continue-on-error: true
      id: eslint
    
    - name: Run Prettier check
      run: npx prettier --check "src/**/*.{ts,tsx,json}" "test/**/*.{ts,tsx,json}"
      continue-on-error: true
      id: prettier
    
    - name: Set lint status
      if: always()
      run: |
        if [ "${{ steps.eslint.outcome }}" = "failure" ] || [ "${{ steps.prettier.outcome }}" = "failure" ]; then
          echo "::error::Linting checks failed"
          exit 1
        fi

  # å…¨ãƒã‚§ãƒƒã‚¯ã®é›†ç´„
  pr-status:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: [type-check, test-coverage, build-check, lint-check]
    if: always()
    steps:
    - name: Check all jobs
      uses: actions/github-script@v7
      with:
        script: |
          const needs = ${{ toJSON(needs) }};
          const failed = Object.entries(needs).filter(([job, data]) => 
            data.result === 'failure'
          ).map(([job]) => job);
          
          if (failed.length > 0) {
            core.setFailed(`The following checks failed: ${failed.join(', ')}`);
          } else {
            console.log('All PR checks passed successfully!');
          }
          
          // Set final status
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.payload.pull_request.head.sha,
            state: failed.length > 0 ? 'failure' : 'success',
            context: 'PR Required Checks',
            description: failed.length > 0 
              ? `${failed.length} check(s) failed` 
              : 'All checks passed'
          });