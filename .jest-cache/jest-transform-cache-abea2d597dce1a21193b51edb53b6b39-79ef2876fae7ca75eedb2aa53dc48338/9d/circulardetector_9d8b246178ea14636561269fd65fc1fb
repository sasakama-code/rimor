ea82848965ebb56b07c31da1b8472e8e
"use strict";
/**
 * CircularDependencyDetector
 * Issue #65: 循環依存検出専用モジュール
 *
 * SOLID原則: 単一責任（循環依存検出のみ）
 * DRY原則: グラフ走査アルゴリズムの再利用
 * KISS原則: シンプルなDFSベースの検出
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CircularDependencyDetector = void 0;
/**
 * 循環依存を検出する専用クラス
 */
class CircularDependencyDetector {
    /**
     * 循環依存を検出
     */
    detectCircularDependencies(dependencies) {
        const graph = this.buildGraph(dependencies);
        const cycles = [];
        const visited = new Set();
        const recursionStack = new Set();
        const detectedCycles = new Set();
        for (const node of graph.keys()) {
            if (!visited.has(node)) {
                const cyclesFromNode = this.dfs(node, graph, visited, recursionStack, []);
                for (const cycle of cyclesFromNode) {
                    const cycleKey = this.getCycleKey(cycle);
                    if (!detectedCycles.has(cycleKey)) {
                        detectedCycles.add(cycleKey);
                        const severity = this.calculateSeverity(cycle);
                        cycles.push({
                            files: cycle,
                            severity: severity,
                            suggestion: this.suggestRefactoring({
                                files: cycle,
                                severity: severity,
                                suggestion: ''
                            })
                        });
                    }
                }
            }
        }
        return cycles;
    }
    /**
     * 依存関係グラフを構築
     */
    buildGraph(dependencies) {
        const graph = new Map();
        for (const dep of dependencies) {
            if (!graph.has(dep.file)) {
                graph.set(dep.file, []);
            }
            graph.set(dep.file, dep.imports);
        }
        return graph;
    }
    /**
     * 深さ優先探索で循環を検出
     */
    dfs(node, graph, visited, recursionStack, path) {
        visited.add(node);
        recursionStack.add(node);
        path.push(node);
        const cycles = [];
        const neighbors = graph.get(node) || [];
        for (const neighbor of neighbors) {
            if (!visited.has(neighbor)) {
                const nestedCycles = this.dfs(neighbor, graph, visited, recursionStack, [...path]);
                cycles.push(...nestedCycles);
            }
            else if (recursionStack.has(neighbor)) {
                // 循環を検出
                const cycleStartIndex = path.indexOf(neighbor);
                if (cycleStartIndex !== -1) {
                    const cycle = [...path.slice(cycleStartIndex), neighbor];
                    cycles.push(cycle);
                }
            }
        }
        recursionStack.delete(node);
        return cycles;
    }
    /**
     * 循環のキーを生成（重複検出用）
     */
    getCycleKey(cycle) {
        const sorted = [...cycle].sort();
        return sorted.join('->');
    }
    /**
     * 循環の重要度を計算
     */
    calculateSeverity(cycle) {
        const length = cycle.length - 1; // 最後の要素は最初の要素の繰り返し
        if (length <= 2) {
            return 'error'; // 2ファイル間の直接的な循環
        }
        else if (length <= 4) {
            return 'warning'; // 3-4ファイル間の循環
        }
        else {
            return 'info'; // 5ファイル以上の循環
        }
    }
    /**
     * リファクタリング提案を生成
     */
    suggestRefactoring(cycle) {
        const suggestions = [];
        const severity = cycle.severity;
        if (severity === 'error') {
            suggestions.push('Consider extracting common functionality to a separate module');
            suggestions.push('Use dependency injection or interfaces to break the direct dependency');
        }
        else if (severity === 'warning') {
            suggestions.push('Review the module boundaries and responsibilities');
            suggestions.push('Consider using event-driven architecture or mediator pattern');
        }
        else {
            suggestions.push('Analyze if all dependencies are necessary');
            suggestions.push('Consider restructuring the module hierarchy');
        }
        // インターフェースベースの解決策を提案
        suggestions.push('Create an interface or abstract class to decouple the modules');
        return suggestions.join('. ');
    }
    /**
     * 循環依存の影響範囲を分析
     */
    analyzeImpact(cycle, allDependencies) {
        const affectedFiles = new Set();
        const testFiles = new Set();
        // 循環に含まれるファイルを追加
        for (const file of cycle.files) {
            affectedFiles.add(file);
            // このファイルをインポートしている他のファイルを検索
            for (const dep of allDependencies) {
                if (dep.imports.includes(file)) {
                    affectedFiles.add(dep.file);
                    if (dep.file.includes('.test.') || dep.file.includes('.spec.')) {
                        testFiles.add(dep.file);
                    }
                }
            }
        }
        // 影響度を計算
        let severity = cycle.severity;
        if (affectedFiles.size > 10) {
            severity = 'error';
        }
        else if (affectedFiles.size > 5 && severity !== 'error') {
            severity = 'warning';
        }
        return {
            affectedFiles: Array.from(affectedFiles),
            testFiles: Array.from(testFiles),
            severity
        };
    }
}
exports.CircularDependencyDetector = CircularDependencyDetector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3Nhc2FrYW1hL1Byb2plY3RzL1JpbW9yL3NyYy9hbmFseXplcnMvZGVwZW5kZW5jeS1hbmFseXNpcy9jaXJjdWxhci1kZXRlY3Rvci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBSUg7O0dBRUc7QUFDSCxNQUFhLDBCQUEwQjtJQUNyQzs7T0FFRztJQUNILDBCQUEwQixDQUFDLFlBQThCO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDNUMsTUFBTSxNQUFNLEdBQXVCLEVBQUUsQ0FBQztRQUN0QyxNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1FBQ2xDLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUV6QyxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQzdCLElBQUksRUFDSixLQUFLLEVBQ0wsT0FBTyxFQUNQLGNBQWMsRUFDZCxFQUFFLENBQ0gsQ0FBQztnQkFFRixLQUFLLE1BQU0sS0FBSyxJQUFJLGNBQWMsRUFBRSxDQUFDO29CQUNuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUN6QyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO3dCQUNsQyxjQUFjLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUM3QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQy9DLE1BQU0sQ0FBQyxJQUFJLENBQUM7NEJBQ1Ys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bmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9zYXNha2FtYS9Qcm9qZWN0cy9SaW1vci9zcmMvYW5hbHl6ZXJzL2RlcGVuZGVuY3ktYW5hbHlzaXMvY2lyY3VsYXItZGV0ZWN0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDaXJjdWxhckRlcGVuZGVuY3lEZXRlY3RvclxuICogSXNzdWUgIzY1OiDlvqrnkrDkvp3lrZjmpJzlh7rlsILnlKjjg6Ljgrjjg6Xjg7zjg6tcbiAqIFxuICogU09MSUTljp/liYc6IOWNmOS4gOiyrOS7u++8iOW+queSsOS+neWtmOaknOWHuuOBruOBv++8iVxuICogRFJZ5Y6f5YmHOiDjgrDjg6njg5XotbDmn7vjgqLjg6vjgrTjg6rjgrrjg6Djga7lho3liKnnlKhcbiAqIEtJU1Pljp/liYc6IOOCt+ODs+ODl+ODq+OBqkRGU+ODmeODvOOCueOBruaknOWHulxuICovXG5cbmltcG9ydCB7IEN5Y2xpY0RlcGVuZGVuY3ksIEZpbGVEZXBlbmRlbmN5IH0gZnJvbSAnLi4vdHlwZXMnO1xuXG4vKipcbiAqIOW+queSsOS+neWtmOOCkuaknOWHuuOBmeOCi+WwgueUqOOCr+ODqeOCuVxuICovXG5leHBvcnQgY2xhc3MgQ2lyY3VsYXJEZXBlbmRlbmN5RGV0ZWN0b3Ige1xuICAvKipcbiAgICog5b6q55Kw5L6d5a2Y44KS5qSc5Ye6XG4gICAqL1xuICBkZXRlY3RDaXJjdWxhckRlcGVuZGVuY2llcyhkZXBlbmRlbmNpZXM6IEZpbGVEZXBlbmRlbmN5W10pOiBDeWNsaWNEZXBlbmRlbmN5W10ge1xuICAgIGNvbnN0IGdyYXBoID0gdGhpcy5idWlsZEdyYXBoKGRlcGVuZGVuY2llcyk7XG4gICAgY29uc3QgY3ljbGVzOiBDeWNsaWNEZXBlbmRlbmN5W10gPSBbXTtcbiAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgY29uc3QgcmVjdXJzaW9uU3RhY2sgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCBkZXRlY3RlZEN5Y2xlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gICAgZm9yIChjb25zdCBub2RlIG9mIGdyYXBoLmtleXMoKSkge1xuICAgICAgaWYgKCF2aXNpdGVkLmhhcyhub2RlKSkge1xuICAgICAgICBjb25zdCBjeWNsZXNGcm9tTm9kZSA9IHRoaXMuZGZzKFxuICAgICAgICAgIG5vZGUsXG4gICAgICAgICAgZ3JhcGgsXG4gICAgICAgICAgdmlzaXRlZCxcbiAgICAgICAgICByZWN1cnNpb25TdGFjayxcbiAgICAgICAgICBbXVxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgZm9yIChjb25zdCBjeWNsZSBvZiBjeWNsZXNGcm9tTm9kZSkge1xuICAgICAgICAgIGNvbnN0IGN5Y2xlS2V5ID0gdGhpcy5nZXRDeWNsZUtleShjeWNsZSk7XG4gICAgICAgICAgaWYgKCFkZXRlY3RlZEN5Y2xlcy5oYXMoY3ljbGVLZXkpKSB7XG4gICAgICAgICAgICBkZXRlY3RlZEN5Y2xlcy5hZGQoY3ljbGVLZXkpO1xuICAgICAgICAgICAgY29uc3Qgc2V2ZXJpdHkgPSB0aGlzLmNhbGN1bGF0ZVNldmVyaXR5KGN5Y2xlKTtcbiAgICAgICAgICAgIGN5Y2xlcy5wdXNoKHtcbiAgICAgICAgICAgICAgZmlsZXM6IGN5Y2xlLFxuICAgICAgICAgICAgICBzZXZlcml0eTogc2V2ZXJpdHkgYXMgJ2Vycm9yJyB8ICd3YXJuaW5nJyB8ICdpbmZvJyxcbiAgICAgICAgICAgICAgc3VnZ2VzdGlvbjogdGhpcy5zdWdnZXN0UmVmYWN0b3JpbmcoeyBcbiAgICAgICAgICAgICAgICBmaWxlczogY3ljbGUsIFxuICAgICAgICAgICAgICAgIHNldmVyaXR5OiBzZXZlcml0eSBhcyAnZXJyb3InIHwgJ3dhcm5pbmcnIHwgJ2luZm8nLFxuICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb246ICcnXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY3ljbGVzO1xuICB9XG5cbiAgLyoqXG4gICAqIOS+neWtmOmWouS/guOCsOODqeODleOCkuani+eviVxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZEdyYXBoKGRlcGVuZGVuY2llczogRmlsZURlcGVuZGVuY3lbXSk6IE1hcDxzdHJpbmcsIHN0cmluZ1tdPiB7XG4gICAgY29uc3QgZ3JhcGggPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nW10+KCk7XG5cbiAgICBmb3IgKGNvbnN0IGRlcCBvZiBkZXBlbmRlbmNpZXMpIHtcbiAgICAgIGlmICghZ3JhcGguaGFzKGRlcC5maWxlKSkge1xuICAgICAgICBncmFwaC5zZXQoZGVwLmZpbGUsIFtdKTtcbiAgICAgIH1cbiAgICAgIGdyYXBoLnNldChkZXAuZmlsZSwgZGVwLmltcG9ydHMpO1xuICAgIH1cblxuICAgIHJldHVybiBncmFwaDtcbiAgfVxuXG4gIC8qKlxuICAgKiDmt7HjgZXlhKrlhYjmjqLntKLjgaflvqrnkrDjgpLmpJzlh7pcbiAgICovXG4gIHByaXZhdGUgZGZzKFxuICAgIG5vZGU6IHN0cmluZyxcbiAgICBncmFwaDogTWFwPHN0cmluZywgc3RyaW5nW10+LFxuICAgIHZpc2l0ZWQ6IFNldDxzdHJpbmc+LFxuICAgIHJlY3Vyc2lvblN0YWNrOiBTZXQ8c3RyaW5nPixcbiAgICBwYXRoOiBzdHJpbmdbXVxuICApOiBzdHJpbmdbXVtdIHtcbiAgICB2aXNpdGVkLmFkZChub2RlKTtcbiAgICByZWN1cnNpb25TdGFjay5hZGQobm9kZSk7XG4gICAgcGF0aC5wdXNoKG5vZGUpO1xuXG4gICAgY29uc3QgY3ljbGVzOiBzdHJpbmdbXVtdID0gW107XG4gICAgY29uc3QgbmVpZ2hib3JzID0gZ3JhcGguZ2V0KG5vZGUpIHx8IFtdO1xuXG4gICAgZm9yIChjb25zdCBuZWlnaGJvciBvZiBuZWlnaGJvcnMpIHtcbiAgICAgIGlmICghdmlzaXRlZC5oYXMobmVpZ2hib3IpKSB7XG4gICAgICAgIGNvbnN0IG5lc3RlZEN5Y2xlcyA9IHRoaXMuZGZzKFxuICAgICAgICAgIG5laWdoYm9yLFxuICAgICAgICAgIGdyYXBoLFxuICAgICAgICAgIHZpc2l0ZWQsXG4gICAgICAgICAgcmVjdXJzaW9uU3RhY2ssXG4gICAgICAgICAgWy4uLnBhdGhdXG4gICAgICAgICk7XG4gICAgICAgIGN5Y2xlcy5wdXNoKC4uLm5lc3RlZEN5Y2xlcyk7XG4gICAgICB9IGVsc2UgaWYgKHJlY3Vyc2lvblN0YWNrLmhhcyhuZWlnaGJvcikpIHtcbiAgICAgICAgLy8g5b6q55Kw44KS5qSc5Ye6XG4gICAgICAgIGNvbnN0IGN5Y2xlU3RhcnRJbmRleCA9IHBhdGguaW5kZXhPZihuZWlnaGJvcik7XG4gICAgICAgIGlmIChjeWNsZVN0YXJ0SW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgY29uc3QgY3ljbGUgPSBbLi4ucGF0aC5zbGljZShjeWNsZVN0YXJ0SW5kZXgpLCBuZWlnaGJvcl07XG4gICAgICAgICAgY3ljbGVzLnB1c2goY3ljbGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVjdXJzaW9uU3RhY2suZGVsZXRlKG5vZGUpO1xuICAgIHJldHVybiBjeWNsZXM7XG4gIH1cblxuICAvKipcbiAgICog5b6q55Kw44Gu44Kt44O844KS55Sf5oiQ77yI6YeN6KSH5qSc5Ye655So77yJXG4gICAqL1xuICBwcml2YXRlIGdldEN5Y2xlS2V5KGN5Y2xlOiBzdHJpbmdbXSk6IHN0cmluZyB7XG4gICAgY29uc3Qgc29ydGVkID0gWy4uLmN5Y2xlXS5zb3J0KCk7XG4gICAgcmV0dXJuIHNvcnRlZC5qb2luKCctPicpO1xuICB9XG5cbiAgLyoqXG4gICAqIOW+queSsOOBrumHjeimgeW6puOCkuioiOeul1xuICAgKi9cbiAgY2FsY3VsYXRlU2V2ZXJpdHkoY3ljbGU6IHN0cmluZ1tdKTogJ2Vycm9yJyB8ICd3YXJuaW5nJyB8ICdpbmZvJyB7XG4gICAgY29uc3QgbGVuZ3RoID0gY3ljbGUubGVuZ3RoIC0gMTsgLy8g5pyA5b6M44Gu6KaB57Sg44Gv5pyA5Yid44Gu6KaB57Sg44Gu57mw44KK6L+U44GXXG4gICAgXG4gICAgaWYgKGxlbmd0aCA8PSAyKSB7XG4gICAgICByZXR1cm4gJ2Vycm9yJzsgLy8gMuODleOCoeOCpOODq+mWk+OBruebtOaOpeeahOOBquW+queSsFxuICAgIH0gZWxzZSBpZiAobGVuZ3RoIDw9IDQpIHtcbiAgICAgIHJldHVybiAnd2FybmluZyc7IC8vIDMtNOODleOCoeOCpOODq+mWk+OBruW+queSsFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gJ2luZm8nOyAvLyA144OV44Kh44Kk44Or5Lul5LiK44Gu5b6q55KwXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOODquODleOCoeOCr+OCv+ODquODs+OCsOaPkOahiOOCkueUn+aIkFxuICAgKi9cbiAgc3VnZ2VzdFJlZmFjdG9yaW5nKGN5Y2xlOiBDeWNsaWNEZXBlbmRlbmN5KTogc3RyaW5nIHtcbiAgICBjb25zdCBzdWdnZXN0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBzZXZlcml0eSA9IGN5Y2xlLnNldmVyaXR5O1xuXG4gICAgaWYgKHNldmVyaXR5ID09PSAnZXJyb3InKSB7XG4gICAgICBzdWdnZXN0aW9ucy5wdXNoKCdDb25zaWRlciBleHRyYWN0aW5nIGNvbW1vbiBmdW5jdGlvbmFsaXR5IHRvIGEgc2VwYXJhdGUgbW9kdWxlJyk7XG4gICAgICBzdWdnZXN0aW9ucy5wdXNoKCdVc2UgZGVwZW5kZW5jeSBpbmplY3Rpb24gb3IgaW50ZXJmYWNlcyB0byBicmVhayB0aGUgZGlyZWN0IGRlcGVuZGVuY3knKTtcbiAgICB9IGVsc2UgaWYgKHNldmVyaXR5ID09PSAnd2FybmluZycpIHtcbiAgICAgIHN1Z2dlc3Rpb25zLnB1c2goJ1JldmlldyB0aGUgbW9kdWxlIGJvdW5kYXJpZXMgYW5kIHJlc3BvbnNpYmlsaXRpZXMnKTtcbiAgICAgIHN1Z2dlc3Rpb25zLnB1c2goJ0NvbnNpZGVyIHVzaW5nIGV2ZW50LWRyaXZlbiBhcmNoaXRlY3R1cmUgb3IgbWVkaWF0b3IgcGF0dGVybicpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWdnZXN0aW9ucy5wdXNoKCdBbmFseXplIGlmIGFsbCBkZXBlbmRlbmNpZXMgYXJlIG5lY2Vzc2FyeScpO1xuICAgICAgc3VnZ2VzdGlvbnMucHVzaCgnQ29uc2lkZXIgcmVzdHJ1Y3R1cmluZyB0aGUgbW9kdWxlIGhpZXJhcmNoeScpO1xuICAgIH1cblxuICAgIC8vIOOCpOODs+OCv+ODvOODleOCp+ODvOOCueODmeODvOOCueOBruino+axuuetluOCkuaPkOahiFxuICAgIHN1Z2dlc3Rpb25zLnB1c2goJ0NyZWF0ZSBhbiBpbnRlcmZhY2Ugb3IgYWJzdHJhY3QgY2xhc3MgdG8gZGVjb3VwbGUgdGhlIG1vZHVsZXMnKTtcblxuICAgIHJldHVybiBzdWdnZXN0aW9ucy5qb2luKCcuICcpO1xuICB9XG5cbiAgLyoqXG4gICAqIOW+queSsOS+neWtmOOBruW9semfv+evhOWbsuOCkuWIhuaekFxuICAgKi9cbiAgYW5hbHl6ZUltcGFjdChcbiAgICBjeWNsZTogQ3ljbGljRGVwZW5kZW5jeSxcbiAgICBhbGxEZXBlbmRlbmNpZXM6IEZpbGVEZXBlbmRlbmN5W11cbiAgKToge1xuICAgIGFmZmVjdGVkRmlsZXM6IHN0cmluZ1tdO1xuICAgIHRlc3RGaWxlczogc3RyaW5nW107XG4gICAgc2V2ZXJpdHk6ICdlcnJvcicgfCAnd2FybmluZycgfCAnaW5mbyc7XG4gIH0ge1xuICAgIGNvbnN0IGFmZmVjdGVkRmlsZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCB0ZXN0RmlsZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcblxuICAgIC8vIOW+queSsOOBq+WQq+OBvuOCjOOCi+ODleOCoeOCpOODq+OCkui/veWKoFxuICAgIGZvciAoY29uc3QgZmlsZSBvZiBjeWNsZS5maWxlcykge1xuICAgICAgYWZmZWN0ZWRGaWxlcy5hZGQoZmlsZSk7XG4gICAgICBcbiAgICAgIC8vIOOBk+OBruODleOCoeOCpOODq+OCkuOCpOODs+ODneODvOODiOOBl+OBpuOBhOOCi+S7luOBruODleOCoeOCpOODq+OCkuaknOe0olxuICAgICAgZm9yIChjb25zdCBkZXAgb2YgYWxsRGVwZW5kZW5jaWVzKSB7XG4gICAgICAgIGlmIChkZXAuaW1wb3J0cy5pbmNsdWRlcyhmaWxlKSkge1xuICAgICAgICAgIGFmZmVjdGVkRmlsZXMuYWRkKGRlcC5maWxlKTtcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoZGVwLmZpbGUuaW5jbHVkZXMoJy50ZXN0LicpIHx8IGRlcC5maWxlLmluY2x1ZGVzKCcuc3BlYy4nKSkge1xuICAgICAgICAgICAgdGVzdEZpbGVzLmFkZChkZXAuZmlsZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g5b2x6Z+/5bqm44KS6KiI566XXG4gICAgbGV0IHNldmVyaXR5OiAnZXJyb3InIHwgJ3dhcm5pbmcnIHwgJ2luZm8nID0gY3ljbGUuc2V2ZXJpdHk7XG4gICAgaWYgKGFmZmVjdGVkRmlsZXMuc2l6ZSA+IDEwKSB7XG4gICAgICBzZXZlcml0eSA9ICdlcnJvcic7XG4gICAgfSBlbHNlIGlmIChhZmZlY3RlZEZpbGVzLnNpemUgPiA1ICYmIHNldmVyaXR5ICE9PSAnZXJyb3InKSB7XG4gICAgICBzZXZlcml0eSA9ICd3YXJuaW5nJztcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgYWZmZWN0ZWRGaWxlczogQXJyYXkuZnJvbShhZmZlY3RlZEZpbGVzKSxcbiAgICAgIHRlc3RGaWxlczogQXJyYXkuZnJvbSh0ZXN0RmlsZXMpLFxuICAgICAgc2V2ZXJpdHlcbiAgICB9O1xuICB9XG59Il0sInZlcnNpb24iOjN9