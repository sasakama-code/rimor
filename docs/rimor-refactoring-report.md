# Rimor `src`ディレクトリ構造最適化・リファクタリング調査レポート

## 1. 調査目的

本レポートは、`Rimor`プロジェクトの`src`ディレクトリ全体の構造を分析し、将来的な保守性・拡張性を向上させるための構造最適化とリファクタリングの可能性を明らかにすることを目的とする。

## 2. 調査概要

以下の観点から調査を実施した。

1.  **モジュール構造と責務の分離:** ディレクトリ構成を分析し、各モジュールが適切な責務を持っているか評価した。
2.  **命名規則の一貫性:** インターフェースやクラスの命名規則に一貫性があるかを確認した。
3.  **クラス構造と設計原則:** 主要なクラスの内部構造を分析し、単一責任の原則（SRP）などの設計原則に従っているか評価した。
4.  **依存関係:** モジュール間の依存関係について簡易的な分析を行った。

## 3. 調査結果

### 3.1. モジュール構造と責務の分離

**評価:** **良好**

- `ai-output`, `analyzers`, `cli`, `core`, `domain-analysis`, `intent-analysis`, `nist`, `plugins`, `report`, `reporting`, `scoring`, `security`といったトップレベルのディレクトリ分割は、それぞれの責務が明確に分かれており、全体として非常に良好な設計と言える。
- 特に、以下の点は高く評価できる。
    - **`report`（レポート内容）** と **`reporting`（レポート手段）** の分離。
    - **`analyzers`（技術的解析）** と **`domain-analysis`（ドメイン解析）** の分離。
    - **`core/interfaces`（抽象）** と **`core/implementations`（具象）** の分離。これは依存性逆転の原則（DIP）を促進する良いプラクティスである。

### 3.2. `utils`ディレクトリの問題点

**評価:** **要改善**

- `utils`ディレクトリが、本来は他の専門モジュールに属するべきユーティリティ関数の置き場所として機能しており、モジュールの凝集度を低下させる要因となっている。
- 以下のファイルは、それぞれの専門モジュールへ移動することが強く推奨される。
    - `utils/scoreCalculator.ts` → `scoring`モジュールへ
    - `utils/securityHelpers.ts` → `security`モジュールへ
    - `utils/codeAnalysisHelper.ts` → `analyzers`モジュールへ
- このリファクタリングを行うことで、各モジュールの自己完結性が高まり、コードの見通しが大幅に改善される。

### 3.3. 命名規則の一貫性

**評価:** **概ね良好（ただし注意点あり）**

- **クラス名・ファイル名:** `HTMLReportBuilder`や`UnifiedAnalysisEngine`など、その役割が分かりやすく命名されており、一貫性が見られる。
- **インターフェース名:** 2つのスタイルが混在している。
    1.  **`I`プレフィックスあり:** `IPlugin`, `IAnalysisEngine`など。主にDIコンテナで管理されるサービスやプラグインの**契約（Contract）**として使用されている。
    2.  **`I`プレフィックスなし:** `AnalysisOptions`, `QualityScore`など。主にデータの**形状（Shape）**を定義する型として使用されている。
- この使い分けは設計上妥当であるが、ルールが暗黙的であるため、`CONTRIBUTING.md`などで**命名規則を明文化**し、チーム全体で一貫性を保つ仕組みを整えることが望ましい。

### 3.4. クラス構造と設計原則

**評価:** **非常に良好**

- `UnifiedAnalysisEngine`クラスをサンプルとして分析した結果、以下の点で優れた設計であることが確認された。
    - **単一責任の原則（SRP）:** 分析ワークフローの制御という単一の責務に集中している。
    - **関心の分離:** キャッシュ管理（`CacheManager`）、パフォーマンス監視（`PerformanceMonitor`）、プラグイン実行（`IPluginManager`）といった関連する責務を、適切に他のクラスやインターフェースに委譲している。
    - **DIの活用:** `IPluginManager`をコンストラクタで注入することにより、疎結合な設計を実現している。
- このような設計は、コードのテスト容易性、再利用性、保守性を高める上で非常に効果的である。

## 4. ディレクトリ構造の有効性評価

追加調査として、特に複雑に見える`core`, `security`, `intent-analysis`ディレクトリの内部構造の有効性を評価した。

- **`core`ディレクトリ:**
    - **評価:** **非常に良好**
    - **分析:** アプリケーションの根幹をなす横断的な機能（エンジン、プラグイン管理、キャッシュ等）を集約し、安定した基盤を提供している。`AnalysisEngine`をファサードとし、`PluginManager`を介して機能が拡張される構造は、柔軟性と堅牢性を両立させている。

- **`security`ディレクトリ:**
    - **評価:** **非常に良好**
    - **分析:** 「入力（`annotations`）」「データモデル（`types`）」「中核ロジック（`analysis`）」「外部連携（`compatibility`）」といった関心事が、それぞれ独立したサブディレクトリに明確に分離されている。変更の影響範囲が限定され、高い保守性を実現している。

- **`intent-analysis`ディレクトリ:**
    - **評価:** **非常に良好**
    - **分析:** テストコードをASTに変換し、それを複数の分析ステージで段階的に処理していく「パイプライン・アーキテクチャ」を採用している。各クラスが単一責任を担っており、疎結合で拡張性の高い設計となっている。

**結論として、主要ディレクトリの内部構造は複雑さに見合った、よく考えられた設計であり、プロジェクトの複雑性を適切に管理できている。**

## 5. 総括と提言

`Rimor`プロジェクトの`src`ディレクトリは、全体として非常によく設計されており、高い保守性を維持している。モジュール分割は適切で、主要なクラスは設計原則に則って実装されている。複雑なディレクトリ構造も、その責務に応じて機能的に分割されており、有効に機能している。

今後のさらなる品質向上のため、以下の点を提言する。

1.  **【最優先】`utils`ディレクトリのリファクタリング:**
    - 本レポートで特定した3つのユーティリティファイル（`scoreCalculator.ts`, `securityHelpers.ts`, `codeAnalysisHelper.ts`）を、それぞれ`scoring`, `security`, `analyzers`モジュールに移動させる。これにより、モジュールの凝集性が向上し、コードベースの理解が容易になる。

2.  **【推奨】命名規則のドキュメント化:**
    - インターフェースの命名規則（`I`プレフィックスの使い分け）を`CONTRIBUTING.md`などの開発者向けドキュメントに明記する。

3.  **【検討】依存関係の可視化:**
    - `dependency-cruiser`のようなツールを導入し、CIプロセスに組み込むことで、モジュール間の意図しない依存関係（特に循環参照）の発生を恒久的に防止する仕組みを構築する。

これらの提言は、現在の高品質なコードベースをさらに発展させ、将来の機能追加や変更に強い、より堅牢なアーキテクチャを維持するために有効である。
