# v0.8.0 リファクタリング詳細実行計画書

## 実行状況サマリー
- **開始日**: 2025-07-27
- **現在フェーズ**: 3（コア再構築）
- **進捗率**: 50%
- **完了タスク数**: 25/50+
- **ブランチ**: feature/v0.8.0-major-refactoring

## リファクタリング方針
- **目的**: Rimorのコアバリュー「テストの質を監査する」への回帰
- **戦略**: 60%の機能削減によるシンプル化 + DIコンテナによる疎結合化
- **期間**: 6週間（2025-07-27 〜 2025-09-07予定）

## フェーズ別詳細タスクリスト

### フェーズ0: 準備段階（2025-07-27）✅ 完了
- [x] feature/v0.8.0-major-refactoringブランチ作成
- [x] v0.8.0-refactoring-plan.md作成（本ファイル）
- [x] v0.8.0-file-changes.md作成
- [x] v0.8.0-test-migration.md作成
- [x] 初期コミット（計画書のみ）

### フェーズ1: 断捨離（2025-07-27 〜 2025-08-03）✅ 完了
- [x] 関連ディレクトリ、テスト、依存関係、CLIコマンドの削除

### フェーズ2: 基盤構築（2025-08-04 〜 2025-08-10）✅ 完了
- [x] DIコンテナ導入 (inversify)
- [x] コアサービスインターフェース定義
- [x] 基本DIバインディング設定

### フェーズ3: コア再構築（2週間: 2025-08-11 〜 2025-08-24）
- [ ] **AnalysisEngine実装**: 3つの旧Analyzerを統合し、AST生成に特化した`src/core/engine.ts`を作成。
- [ ] **v0.7.0セキュリティ機能の完成**: `TypeBasedSecurityEngine`, `ModularTestAnalyzer`, `FlowSensitiveAnalyzer`の実装を完了させる。
- [ ] **簡素化ドメインルール実装**: `src/domain/simple-rules.ts`として、YAMLベースのルール定義と必須テスト項目チェッカーを実装。
- [ ] **プラグインマネージャー簡素化**: サンドボックスとレガシーサポートを廃止し、シンプルな実行機能に特化。

---

### フェーズ4: 確定的レポーティングと最終統合（2週間: 2025-08-25 〜 2025-09-07）

**目的**: 静的解析の信頼性を100%担保しつつ、人間とAIの両方にとって分かりやすい監査結果を提供する。AIによる「生成ぶれ」を完全に排除し、常に決定論的な出力を保証する。

#### 4.1 監査結果の構造化 (Single Source of Truth)
- [ ] **JSONスキーマ定義**: 監査結果（脆弱性、コード品質、テストカバレッジ等）を表現するための厳密なJSONスキーマを`src/reporting/schema.json`として定義する。
    - 汚染のSource/Path/Sink、脆弱性タイプ、深刻度、コード位置情報（ファイル、行、列）を必須フィールドとする。
- [ ] **構造化レポーター実装**: `AnalysisEngine`の分析結果を受け取り、上記スキーマに準拠した単一のJSONオブジェクトを生成する`src/reporting/StructuredReporter.ts`を実装する。
    - このJSONが、以降のすべての出力の「単一の真実の源」となる。

#### 4.2 テンプレートベースの自然言語レポート生成
- [ ] **レポートテンプレート作成**: `src/reporting/templates/`ディレクトリに、HandlebarsやEJS等のテンプレートエンジン用のファイルを作成する。
    - `summary.md.hbs`: サマリーレポート用テンプレート。
    - `detailed.md.hbs`: 詳細レポート用テンプレート。
- [ ] **テンプレートエンジン導入**: `package.json`にテンプレートエンジンライブラリを追加。
- [ ] **決定論的レポートジェネレーター実装**: `src/reporting/TemplatedReporter.ts`を作成。`StructuredReporter`が生成したJSONを元に、テンプレートを適用してMarkdown形式のレポートを生成する。
    - AIによる自由生成を完全に排除し、常に同じJSONから同じレポートが生成されることを保証する。

#### 4.3 インライン・アノテーション生成
- [ ] **アノテーション生成ロジック実装**: `src/reporting/AnnotationGenerator.ts`を作成。JSONデータを元に、問題箇所に対応するインラインコメント（例: `// RIMOR-SINK: [critical] SQL_INJECTION ...`）を生成する。
- [ ] **ファイル書き込み機能**: 生成したアノテーションを、オプションに応じて対象のソースコードのコピーに書き込む機能を実装する。

#### 4.4 CLIの再構築と統合
- [ ] **コマンド集約**: CLIコマンドを以下の通り再設計・実装する。
    - `rimor analyze <path>`: デフォルトの人間向けサマリーレポート（テンプレート生成）をコンソールに出力。
    - `rimor analyze <path> --output-json <file>`: 構造化JSONを指定ファイルに出力。
    - `rimor analyze <path> --output-markdown <file>`: 詳細Markdownレポートを指定ファイルに出力。
    - `rimor analyze <path> --annotate`: コードにインライン・アノテーションを追記。
- [ ] **DIコンテナからのサービス注入**: 全てのコマンドがDIコンテナから`AnalysisEngine`や`StructuredReporter`等のサービスを受け取るようにリファクタリングする。

#### 4.5 テストとドキュメント
- [ ] **テスト作成**:
    - `src/reporting/`配下の全クラスに対する単体テストを作成。
    - 特定の入力コードに対して、生成されるJSON、Markdownレポート、アノテーションが期待通りであるか検証する統合テストを作成。
- [ ] **ドキュメント更新**:
    - `README.md`とユーザーガイドに新しいCLIコマンド体系と出力オプションについて記述。
    - `docs/api-specification.md`にJSON出力のスキーマ仕様を追記。
    - `CHANGELOG.md`を更新。

#### 4.6 最終調整
- [ ] パフォーマンステスト（5ms/ファイル以下）
- [ ] メモリ使用量の最適化
- [ ] エラーハンドリングの改善
- [ ] 最終的なコードレビュー

---

## 成功指標
- [ ] **決定論的出力**: 同一コード・同一設定に対し、複数回実行してもバイナリレベルで同一のJSONレポートが生成される。
- [ ] ファイル数: 40%削減（現在の60%に）
- [ ] コード行数: 50%削減
- [ ] テスト実行時間: 30%短縮
- [ ] ビルド時間: 40%短縮
- [ ] 解析速度: 5ms/ファイル以下維持

## リスクと対策
1. **リスク**: 削除による機能喪失
   - **対策**: 各削除前にユーザーガイドで使用状況確認
2. **リスク**: v0.7.0機能の実装困難
   - **対策**: 最小限の実装から始め、段階的に機能追加
3. **リスク**: テストカバレッジの低下
   - **対策**: 新規テストを優先的に作成
4. **リスク(New)**: レポートテンプレートの管理が複雑化する。
   - **対策**: テンプレートのロジックを最小限に保ち、複雑なデータ整形は`TemplatedReporter.ts`側で行う。

## コミット規約
- フォーマット: `feat(v0.8.0): [Phase#] 具体的な変更内容`
- 例: `feat(v0.8.0): [Phase4] Implement structured JSON reporter`
- 各タスク完了時に意味のある単位でコミット。
